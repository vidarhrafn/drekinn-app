<!DOCTYPE html>
<html lang="is">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Málstöðin – Mynd + spjallæfing (skólastofa)</title>
  <!-- React + Babel + Tailwind (CDN) -->
  <script src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
  <script src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
  <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
  <script src="https://cdn.tailwindcss.com"></script>
  <style>
    /* Japandi-ish look */
    :root {
      --bg-grad-start: #f8f7f4;
      --bg-grad-end: #e8e6e1;
      --ink: #2d2d2d;
      --muted: #6b7280;
      --ok: #4caf50; --ok-100: #e8f5e9;
      --sel: #2196f3; --sel-100: #e3f2fd;
      --err: #f44336; --err-100: #ffebee;
    }
    body { background: linear-gradient(to bottom, var(--bg-grad-start) 0%, var(--bg-grad-end) 100%); }
    .card { background: #fff; border: 1px solid #e5e7eb; box-shadow: 0 1px 2px rgba(0,0,0,.04); }
    .bubble-user { background: #eef6ff; }
    .bubble-bot { background: #e6f3ea; }
    .bubble-grammar { background: #e8f0fe; }
  </style>
</head>
<body class="min-h-screen text-[15px] text-[color:var(--ink)]">
  <div id="app" class="mx-auto max-w-5xl px-6 py-8"></div>

  <script type="text/babel">
    const { useState, useRef, useEffect } = React;

    /**
     * OpenAI integration
     * Expects a Netlify function at '/.netlify/functions/openai' that returns
     * { content: string } where content is a JSON string we can parse.
     */
    async function callOpenAI(payload) {
      const r = await fetch('/.netlify/functions/openai', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify(payload),
      });
      const data = await r.json();
      if (!r.ok || data.error) throw new Error(data.error || `HTTP ${r.status}`);
      return data.content;
    }

    // Helper: robust JSON fence cleanup (```json ... ```)
    function parseJSONSafe(raw) {
      let clean = (raw || '').trim();
      if (clean.startsWith('```')) {
        clean = clean.replace(/```json\n?/g, '').replace(/```\n?/g, '').trim();
      }
      try { return JSON.parse(clean); } catch(e) { return { grammar: null, response: clean }; }
    }

    /** System prompt for one-question-at-a-time classroom talk **/
    const SYSTEM_PROMPT = `Þú ert vingjarnlegur íslenskukennari sem ræðir við A1–A2 nemanda um mynd.
REGLUR:
- Spyrðu AÐEINS eina spurningu í einu, stutta og skýra (1 setning).
- Byrjaðu á hlýlegri, stuttri staðfestingu eða hrósi (1 lína).
- Notaðu einfaldan orðaforða (A1–A2) og vísaðu í atriði úr MYNDALÝSINGU ef þarf.
- Ef nemandi spyr: "Er þetta rétt?", "Eru þau X?", eða gerir staðhæfingu með tölum/litum/hlutum: 
  • Svaraðu fyrst skýrt með JÁ / NEI / NÆRRI-ÞVÍ og segðu réttu töluna eða staðreyndina í sömu setningu.
  • Útskýrðu í 1 stuttri aukasetningu (t.d. "Það eru 9 börn: 4 við borðið, 4 aftast og 1 að mála.").
- Gefðu MJÚKA, STUTTA málfarsendurgjöf aðeins ef gróf villa er í svari nemanda. Aldrei um greinarmerki eða smávillur.
- Aldrei gefa einkunnir.
SVARAÐU AÐEINS MEÐ JSON:
{
  "grammar": "Málfarsendurgjöf BARA ef grófar villur. Ef ekkert athugavert: null.",
  "response": "Hlý staðfesting + (ef við á) skýrt JÁ/NEI með réttri staðreynd + ein ný spurning."
}`;

    // Seed image description for grounding
    const IMAGE_CONTEXT = `
MYND: Litrík grunnskólastofa.
HEILDARFJÖLDI BARNA: 9 (níu).
UPPSETNING OG ATRIÐI:
- Vinstri fremri kantur: Drengur í hvítum svuntu málar á striga á trönum. Á striganum er blátt dýr (líkt hesti) með gulum sólpunktum og grænu tré. Við hliðina eru litadótar: 3 litadósa og krukkur með penslum.
- Miðjuborð (stórt, ljósbrúnt): Fjögur börn sitja þar.
  • Stelpa í hvítum bol og fjólubluxum teiknar með tússpenna.
  • Drengur í grænum bol sker pappír með skærum.
  • Stelpa með tvær hnakka (svartar kollar) í bláum peysu með fiðrildi límir/raðar pappírsstrimlum.
  • Drengur í appelsínugulum bol límir fjólublá form á bláan pappír.
  Á borðinu sjást: skæri (minnst tvö pör), límflaska, stíf lím (glue stick), litir/tússar, blýantar, reglustika, bók/stílabók, pappírsstrimlar. Rauðir stólar í kring.
- Aftast hægra megin: Hópur fjögurra barna stendur og spjallar (blond stelpa í bleikum bol, rauðhærð stelpa með gleraugu, drengur í bláum bol, annar drengur í fjólublíkum bol).
- Kennarinn: Fullorðin kona í blárri kápu/treyju heldur á grænni möppu hægra megin nálægt töflunni og dyrunum.
- Tafla: Stafrófsrönd "Aa–Bb–Ce–..." og tölur 1–5. Bandaríski fáninn hangir við töfluna.
- Tæki og rými: Klukka yfir dyrum, hangandi sjónvarp/lofttæki, hurð með gulu gleri, kennaraborð með borðlímmiða/klemmu (tape-dispenser).
- Vinstri bakgrunnur: Stórir gluggar með grænum trjám og túnum fyrir utan. Vaskur með sápu (SOAP 30 oz) og pappírsþurrkuboxi á vegg.
- Stemning: Glöð, virk og samvinnufull.
SANNREYNDINGARSTAÐREYNDIR (nota í svörum):
- Börn á mynd: 9.
- Börn við miðjuborð: 4.
- Börn sem standa aftast: 4.
- Barn sem málar á striga: 1.
- Kennari: 1 (kona).
- Tölur á töflu: 1 til 5.
- Helstu hlutir: skæri, lím (flaska og límstift), reglustika, litir, bók, pappír, trönur, penslar, málningardósir, sjónvarp, vaskur, sápa, pappírsþurrkur.
`;

    function App() {
      const [messages, setMessages] = useState([]); // {role: 'user'|'bot'|'grammar', text}
      const [input, setInput] = useState('');
      const [loading, setLoading] = useState(false);
      const scrollerRef = useRef(null);

      // QUIZ state
      const [quizQ, setQuizQ] = useState(null); // {question, options:[{text, correct}], explanation}
      const [quizAnswered, setQuizAnswered] = useState(false);
      const [quizScore, setQuizScore] = useState({correct:0, total:0});

      // helpers
      const pick = (arr) => arr[Math.floor(Math.random()*arr.length)];
      const shuffle = (arr) => arr.map(v=>({v, r:Math.random()})).sort((a,b)=>a.r-b.r).map(({v})=>v);

      const questionBank = [
        {
          question: 'Hversu mörg börn eru á myndinni?',
          options: [
            { text: '7', correct: false },
            { text: '8', correct: false },
            { text: '9', correct: true },
            { text: '10', correct: false },
          ],
          explanation: 'Það eru 9 börn: 4 við borðið, 4 aftast og 1 að mála.'
        },
        {
          question: 'Hversu mörg börn sitja við stóra borðið?',
          options: [
            { text: '2', correct: false },
            { text: '3', correct: false },
            { text: '4', correct: true },
            { text: '5', correct: false },
          ],
          explanation: 'Fjögur börn sitja við borðið.'
        },
        {
          question: 'Hvað sérðu á töflunni?',
          options: [
            { text: 'Tölurnar 1–5 og stafróf', correct: true },
            { text: 'Dýr og tré', correct: false },
            { text: 'Ekkert', correct: false },
            { text: 'Jöfnur í algebru', correct: false },
          ],
          explanation: 'Á töflunni sjást tölurnar 1–5 og stafrófsrönd.'
        },
        {
          question: 'Er bandaríski fáninn á myndinni?',
          options: [
            { text: 'Já', correct: true },
            { text: 'Nei', correct: false },
          ],
          explanation: 'Já, hann hangir við töfluna hægra megin.'
        },
        {
          question: 'Hvað er barnið á trönunum að gera?',
          options: [
            { text: 'Málar blátt dýr og tré', correct: true },
            { text: 'Les bók', correct: false },
            { text: 'Spilar á gítar', correct: false },
            { text: 'Reiknar dæmi', correct: false },
          ],
          explanation: 'Barnið málar blátt dýr (líkt hesti), sól og tré.'
        },
        {
          question: 'Hvar stendur kennarinn?',
          options: [
            { text: 'Hægra megin nálægt töflunni og dyrunum', correct: true },
            { text: 'Við gluggana vinstra megin', correct: false },
            { text: 'Við vaskinn', correct: false },
            { text: 'Utan við stofuna', correct: false },
          ],
          explanation: 'Kennarinn stendur hægra megin með græna möppu.'
        },
        {
          question: 'Hvaða verkfæri og efni eru á borðinu?',
          options: [
            { text: 'Skæri, lím, reglustika, litir og pappír', correct: true },
            { text: 'Hamar og naglar', correct: false },
            { text: 'Skyr og rjómi', correct: false },
            { text: 'Hárblásari og greiða', correct: false },
          ],
          explanation: 'Á borðinu eru skæri, lím (flaska + límstift), reglustika, litir og pappír.'
        },
        {
          question: 'Eru fjögur börn að standa aftast og spjalla?',
          options: [
            { text: 'Já', correct: true },
            { text: 'Nei', correct: false },
          ],
          explanation: 'Já, fjögur börn standa aftast í hóp.'
        },
        {
          question: 'Er sjónvarp/lofttæki hangandi á veggnum?',
          options: [
            { text: 'Já', correct: true },
            { text: 'Nei', correct: false },
          ],
          explanation: 'Já, hangandi skjár/tæki er á veggnum.'
        },
        {
          question: 'Er vaskur með sápu vinstra megin?',
          options: [
            { text: 'Já', correct: true },
            { text: 'Nei', correct: false },
          ],
          explanation: 'Já, vaskur og sápa eru undir gluggunum.'
        },
      ];

      function askRandomQuestion(){
        const q = { ...pick(questionBank) };
        q.options = shuffle(q.options);
        setQuizQ(q);
        setQuizAnswered(false);
      }

      function answerOption(idx){
        if (!quizQ || quizAnswered) return;
        const correct = quizQ.options[idx].correct;
        setQuizAnswered(true);
        setQuizScore(s=>({correct: s.correct + (correct?1:0), total: s.total + 1}));
      }

      // Auto scroll to bottom
      useEffect(() => {
        if (scrollerRef.current) {
          scrollerRef.current.scrollTop = scrollerRef.current.scrollHeight;
        }
      }, [messages, loading]);

      // Kick off with a friendly opener
      useEffect(() => {
        setMessages([
          { role: 'bot', text: 'Hæ! Skoðum myndina saman. Hvað heldur þú að þau séu að læra?' }
        ]);
      }, []);

      async function send() {
        if (!input.trim() || loading) return;
        const userText = input.trim();
        setInput('');
        setMessages(prev => [...prev, { role: 'user', text: userText }]);
        setLoading(true);
        try {
          const history = messages
            .filter(m => m.role !== 'grammar')
            .map(m => `${m.role === 'user' ? 'Nemandi' : 'Kennari'}: ${m.text}`)
            .join('
');

          const userPrompt = `MYNDALÝSING:
${IMAGE_CONTEXT}

SAMTAL HINGAÐ TIL:
${history}

SÍÐASTA SVAR NEMANDA:
${userText}

Gerðu nú næstu *einu* spurningu (stutta) og gefðu aðeins málfarsendurgjöf ef gróf villa er í svari nemanda.`;

          const content = await callOpenAI({
            model: 'gpt-4o',
            temperature: 0.7,
            max_tokens: 300,
            messages: [
              { role: 'system', content: SYSTEM_PROMPT },
              { role: 'user', content: userPrompt }
            ]
          });

          const parsed = parseJSONSafe(content);

          if (parsed.grammar && parsed.grammar !== 'null') {
            setMessages(prev => [...prev, { role: 'grammar', text: parsed.grammar }]);
          }
          setMessages(prev => [...prev, { role: 'bot', text: parsed.response || 'Frábært! Hvað sérðu meira á myndinni?' }]);
        } catch (e) {
          setMessages(prev => [...prev, { role: 'bot', text: 'Úbbs! Það kom upp villa. Reyndu aftur.' }]);
          console.error(e);
        } finally {
          setLoading(false);
        }
      }

      function onKey(e){ if(e.key==='Enter' && !e.shiftKey){ e.preventDefault(); send(); } }

      return (
        <main className="space-y-6">
          <header className="flex items-center justify-between">
            <div>
              <h1 className="text-2xl font-normal tracking-tight">Málstöðin – Mynd + spjallæfing</h1>
              <p className="text-[color:var(--muted)]">Stig: A1–A2 · Þú færð eina spurningu í einu og mjúka málfarsendurgjöf ef þarf.</p>
            </div>
            <span className="text-2xl" title="Æfing um skólastofu">🏫</span>
          </header>

          <section className="grid grid-cols-1 md:grid-cols-2 gap-6">
            {/* Image card */}
            <div className="card rounded-2xl overflow-hidden">
              <div className="p-4 border-b border-gray-200 flex items-center justify-between">
                <h2 className="font-normal">Mynd</h2>
                <span className="text-[13px] text-[color:var(--muted)]">Lýstu því sem þú sérð</span>
              </div>
              <div className="p-4">
                <!-- REPLACE src WITH YOUR HOSTED IMAGE PATH -->
                <img src="classroom.jpg" alt="Skólastofa með börnum að vinna list og handverk" className="w-full rounded-xl border border-gray-200" />
                <p className="mt-3 text-[color:var(--muted)] text-sm">Vísbendingar: tölur á töflu, borð með skærum og lími, barn að mála á striga, kennari til hliðar.</p>
              </div>
            </div>

            {/* Chat card */}
            <div className="card rounded-2xl flex flex-col max-h-[70vh]">
              <div className="p-4 border-b border-gray-200 flex items-center gap-2">
                <h2 className="font-normal">Samtal</h2>
                <span className="text-[12px] text-[color:var(--muted)]">Eina spurningu í einu ✨</span>
              </div>

              <div ref={scrollerRef} className="flex-1 overflow-y-auto p-4 space-y-3">
                {messages.map((m, i) => (
                  <div key={i} className={
                    m.role === 'user' ? 'ml-auto max-w-[85%] bubble-user rounded-2xl px-3 py-2 shadow-sm' :
                    m.role === 'grammar' ? 'mx-auto max-w-[85%] bubble-grammar rounded-2xl px-3 py-2 shadow-sm text-sm' :
                    'mr-auto max-w-[85%] bubble-bot rounded-2xl px-3 py-2 shadow-sm'
                  }>
                    <div className="text-[13px] text-[color:var(--muted)] mb-1">
                      {m.role === 'user' ? 'Þú' : m.role === 'grammar' ? '📚 Málfar' : 'Mími'}
                    </div>
                    <div className="leading-relaxed whitespace-pre-wrap">{m.text}</div>
                  </div>
                ))}
                {loading && (
                  <div className="mr-auto max-w-[60%] bubble-bot rounded-2xl px-3 py-2 shadow-sm text-[14px]">...
                  </div>
                )}
              </div>

              <div className="border-t border-gray-200 p-3">
                <div className="flex items-end gap-2">
                  <textarea
                    className="flex-1 resize-none h-12 rounded-xl border border-gray-200 px-3 py-2 focus:outline-none focus:ring-2 focus:ring-[color:var(--sel)]"
                    placeholder="Skrifaðu svarið þitt hér og ýttu á Enter..."
                    value={input}
                    onChange={(e)=>setInput(e.target.value)}
                    onKeyDown={onKey}
                  />
                  <button onClick={send} disabled={loading || !input.trim()}
                    className="rounded-xl px-4 py-2 bg-[color:var(--sel)] text-white disabled:opacity-50 hover:opacity-90 transition">
                    {loading ? 'Sendi…' : 'Senda'}
                  </button>
                </div>
                <p className="text-[12px] text-[color:var(--muted)] mt-2">Vísbending: Þú getur svarað t.d. „Ég held að þau læri stærðfræði af því að tölur eru á töflunni.“</p>
              </div>
            </div>
                      {/* Quiz card */}
            <div className=\"card rounded-2xl p-4 md:col-span-2\">
              <div className=\"flex items-center justify-between border-b border-gray-200 pb-3 mb-3\">
                <h2 className=\"font-normal\">Quiz – Staðreyndir um myndina</h2>
                <div className=\"text-sm text-[color:var(--muted)]\">Stig: {quizScore.correct}/{quizScore.total}</div>
              </div>
              <div className=\"space-y-3\">
                {!quizQ && (
                  <button onClick={askRandomQuestion} className=\"rounded-xl px-4 py-2 bg-[color:var(--sel)] text-white hover:opacity-90 transition\">Spyrja um myndina</button>
                )}
                {quizQ && (
                  <div className=\"space-y-3\">
                    <p className=\"text-[15px]\"><strong>Spurning:</strong> {quizQ.question}</p>
                    <div className=\"grid sm:grid-cols-2 gap-2\">
                      {quizQ.options.map((op,idx)=>{
                        const base = 'rounded-xl px-3 py-2 border transition text-left';
                        const idle = 'border-gray-200 hover:bg-[color:var(--sel-100)]';
                        const good = 'border-[color:var(--ok)] bg-[color:var(--ok-100)]';
                        const bad  = 'border-[color:var(--err)] bg-[color:var(--err-100)]';
                        const cls = !quizAnswered ? `${base} ${idle}` : `${base} ${op.correct?good:bad}`;
                        return (
                          <button key={idx} onClick={()=>answerOption(idx)} disabled={quizAnswered} className={cls}>
                            {op.text}
                          </button>
                        );})}
                    </div>
                    {quizAnswered && (
                      <div className=\"text-sm text-[color:var(--muted)]\">{quizQ.explanation}</div>
                    )}
                    <div className=\"pt-1\">
                      <button onClick={()=>{ setQuizQ(null); }} className=\"rounded-xl px-4 py-2 border border-gray-300 hover:bg-gray-50\">Næsta spurning</button>
                    </div>
                  </div>
                )}
              </div>
            </div>
          </section>

          <footer className="pt-4 text-[13px] text-[color:var(--muted)]">
            <p>Gervigreind: gpt-4o · hitastig 0.7 · max 300 tokens. Málfarsendurgjöf er væg og birtist í blárri bobblu.</p>
          </footer>
        </main>
      );
    }

    ReactDOM.createRoot(document.getElementById('app')).render(<App/>);
  </script>
</body>
</html>
