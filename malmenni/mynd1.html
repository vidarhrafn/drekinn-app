<!DOCTYPE html>
<html lang="is">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>M√°lst√∂√∞in ‚Äì Mynd + spjall√¶fing (sk√≥lastofa)</title>
  <!-- React + Babel + Tailwind (CDN) -->
  <script src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
  <script src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
  <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
  <script src="https://cdn.tailwindcss.com"></script>
  <style>
    /* Japandi-ish look */
    :root {
      --bg-grad-start: #f8f7f4;
      --bg-grad-end: #e8e6e1;
      --ink: #2d2d2d;
      --muted: #6b7280;
      --ok: #4caf50; --ok-100: #e8f5e9;
      --sel: #2196f3; --sel-100: #e3f2fd;
      --err: #f44336; --err-100: #ffebee;
    }
    body { background: linear-gradient(to bottom, var(--bg-grad-start) 0%, var(--bg-grad-end) 100%); }
    .card { background: #fff; border: 1px solid #e5e7eb; box-shadow: 0 1px 2px rgba(0,0,0,.04); }
    .bubble-user { background: #eef6ff; }
    .bubble-bot { background: #e6f3ea; }
    .bubble-grammar { background: #e8f0fe; }
  </style>
</head>
<body class="min-h-screen text-[15px] text-[color:var(--ink)]">
  <div id="app" class="mx-auto max-w-5xl px-6 py-8"></div>

  <script type="text/babel">
    const { useState, useRef, useEffect } = React;

    /**
     * OpenAI integration
     * Expects a Netlify function at '/.netlify/functions/openai' that returns
     * { content: string } where content is a JSON string we can parse.
     */
    async function callOpenAI(payload) {
      const r = await fetch('/.netlify/functions/openai', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify(payload),
      });
      const data = await r.json();
      if (!r.ok || data.error) throw new Error(data.error || `HTTP ${r.status}`);
      return data.content;
    }

    // Helper: robust JSON fence cleanup (```json ... ```)
    function parseJSONSafe(raw) {
      let clean = (raw || '').trim();
      if (clean.startsWith('```')) {
        clean = clean.replace(/```json\n?/g, '').replace(/```\n?/g, '').trim();
      }
      try { return JSON.parse(clean); } catch(e) { return { grammar: null, response: clean }; }
    }

    /** System prompt for one-question-at-a-time classroom talk **/
    const SYSTEM_PROMPT = `√û√∫ ert vingjarnlegur √≠slenskukennari sem r√¶√∞ir vi√∞ A1‚ÄìA2 nemanda um mynd.
REGLUR:
- Spyr√∞u A√êEINS eina spurningu √≠ einu, stutt og sk√Ωrt (1 setning).
- Byrja√∞u alltaf √° hl√Ωlegu hr√≥si e√∞a sta√∞festingu (1 stutt l√≠na).
- Eftir svari√∞ fr√° nemanda: gef√∞u MJ√öKA, STUTTA m√°lfarsendurgj√∂f a√∞eins ef gr√≥far villur.
- Ekki kenna greinarmerki e√∞a sm√°villur. Ekki gefa einkunnir.
- Haltu or√∞afor√∞a √° A1‚ÄìA2 stigi og v√≠sa√∞u √≠ √æa√∞ sem s√©st √° myndinni (b√∂rn, kennari, bor√∞, litir, sk√¶ri, o.s.frv.).
SVARA√êU A√êEINS ME√ê JSON:
{
  "grammar": "M√°lfarsendurgj√∂f BARA ef gr√≥far villur. Ef ekkert athugavert: null.",
  "response": "stutt, hl√Ω l√≠na + ein spurning."
}`;

    // Seed image description for grounding
    const IMAGE_CONTEXT = `Mynd af l√≠flegri sk√≥lastofu: nokkur b√∂rn sitja vi√∞ bor√∞ og klippa, teikna og l√≠ma. Eitt barn m√°lar √° striga. Kennari stendur til hli√∞ar. √Å t√∂flunni sj√°st t√∂lustafir. Gluggi, vaskur, l√≠m, sk√¶ri og litir sj√°st.`;

    function App() {
      const [messages, setMessages] = useState([]); // {role: 'user'|'bot'|'grammar', text}
      const [input, setInput] = useState('');
      const [loading, setLoading] = useState(false);
      const scrollerRef = useRef(null);

      // Auto scroll to bottom
      useEffect(() => {
        if (scrollerRef.current) {
          scrollerRef.current.scrollTop = scrollerRef.current.scrollHeight;
        }
      }, [messages, loading]);

      // Kick off with a friendly opener
      useEffect(() => {
        setMessages([
          { role: 'bot', text: 'H√¶! Sko√∞um myndina saman. Hva√∞ heldur √æ√∫ a√∞ √æau s√©u a√∞ l√¶ra?' }
        ]);
      }, []);

      async function send() {
        if (!input.trim() || loading) return;
        const userText = input.trim();
        setInput('');
        setMessages(prev => [...prev, { role: 'user', text: userText }]);
        setLoading(true);
        try {
          const history = messages
            .filter(m => m.role !== 'grammar')
            .map(m => `${m.role === 'user' ? 'Nemandi' : 'Kennari'}: ${m.text}`)
            .join('\n');

          const userPrompt = `MYNDAL√ùSING:\n${IMAGE_CONTEXT}\n\nSAMTAL HINGA√ê TIL:\n${history}\n\nS√ç√êASTA SVAR NEMANDA:\n${userText}\n\nGer√∞u n√∫ n√¶stu *einu* spurningu (stutta) og gef√∞u a√∞eins m√°lfarsendurgj√∂f ef gr√≥f villa er √≠ svari nemanda.`;

          const content = await callOpenAI({
            model: 'gpt-4o',
            temperature: 0.7,
            max_tokens: 300,
            messages: [
              { role: 'system', content: SYSTEM_PROMPT },
              { role: 'user', content: userPrompt }
            ]
          });

          const parsed = parseJSONSafe(content);

          if (parsed.grammar && parsed.grammar !== 'null') {
            setMessages(prev => [...prev, { role: 'grammar', text: parsed.grammar }]);
          }
          setMessages(prev => [...prev, { role: 'bot', text: parsed.response || 'Fr√°b√¶rt! Hva√∞ s√©r√∞u meira √° myndinni?' }]);
        } catch (e) {
          setMessages(prev => [...prev, { role: 'bot', text: '√öbbs! √ûa√∞ kom upp villa. Reyndu aftur.' }]);
          console.error(e);
        } finally {
          setLoading(false);
        }
      }

      function onKey(e){ if(e.key==='Enter' && !e.shiftKey){ e.preventDefault(); send(); } }

      return (
        <main className="space-y-6">
          <header className="flex items-center justify-between">
            <div>
              <h1 className="text-2xl font-normal tracking-tight">M√°lst√∂√∞in ‚Äì Mynd + spjall√¶fing</h1>
              <p className="text-[color:var(--muted)]">Stig: A1‚ÄìA2 ¬∑ √û√∫ f√¶r√∞ eina spurningu √≠ einu og mj√∫ka m√°lfarsendurgj√∂f ef √æarf.</p>
            </div>
            <span className="text-2xl" title="√Üfing um sk√≥lastofu">üè´</span>
          </header>

          <section className="grid grid-cols-1 md:grid-cols-2 gap-6">
            {/* Image card */}
            <div className="card rounded-2xl overflow-hidden">
              <div className="p-4 border-b border-gray-200 flex items-center justify-between">
                <h2 className="font-normal">Mynd</h2>
                <span className="text-[13px] text-[color:var(--muted)]">L√Ωstu √æv√≠ sem √æ√∫ s√©r√∞</span>
              </div>
              <div className="p-4">
                {/* REPLACE src WITH YOUR HOSTED IMAGE PATH */}

                <img src="classroom.jpg" alt="Sk√≥lastofa me√∞ b√∂rnum a√∞ vinna list og handverk" className="w-full rounded-xl border border-gray-200" />
                <p className="mt-3 text-[color:var(--muted)] text-sm">V√≠sbendingar: t√∂lur √° t√∂flu, bor√∞ me√∞ sk√¶rum og l√≠mi, barn a√∞ m√°la √° striga, kennari til hli√∞ar.</p>
              </div>
            </div>

            {/* Chat card */}
            <div className="card rounded-2xl flex flex-col max-h-[70vh]">
              <div className="p-4 border-b border-gray-200 flex items-center gap-2">
                <h2 className="font-normal">Samtal</h2>
                <span className="text-[12px] text-[color:var(--muted)]">Eina spurningu √≠ einu ‚ú®</span>
              </div>

              <div ref={scrollerRef} className="flex-1 overflow-y-auto p-4 space-y-3">
                {messages.map((m, i) => (
                  <div key={i} className={
                    m.role === 'user' ? 'ml-auto max-w-[85%] bubble-user rounded-2xl px-3 py-2 shadow-sm' :
                    m.role === 'grammar' ? 'mx-auto max-w-[85%] bubble-grammar rounded-2xl px-3 py-2 shadow-sm text-sm' :
                    'mr-auto max-w-[85%] bubble-bot rounded-2xl px-3 py-2 shadow-sm'
                  }>
                    <div className="text-[13px] text-[color:var(--muted)] mb-1">
                      {m.role === 'user' ? '√û√∫' : m.role === 'grammar' ? 'üìö M√°lfar' : 'M√≠mi'}
                    </div>
                    <div className="leading-relaxed whitespace-pre-wrap">{m.text}</div>
                  </div>
                ))}
                {loading && (
                  <div className="mr-auto max-w-[60%] bubble-bot rounded-2xl px-3 py-2 shadow-sm text-[14px]">...
                  </div>
                )}
              </div>

              <div className="border-t border-gray-200 p-3">
                <div className="flex items-end gap-2">
                  <textarea
                    className="flex-1 resize-none h-12 rounded-xl border border-gray-200 px-3 py-2 focus:outline-none focus:ring-2 focus:ring-[color:var(--sel)]"
                    placeholder="Skrifa√∞u svari√∞ √æitt h√©r og √Ωttu √° Enter..."
                    value={input}
                    onChange={(e)=>setInput(e.target.value)}
                    onKeyDown={onKey}
                  />
                  <button onClick={send} disabled={loading || !input.trim()}
                    className="rounded-xl px-4 py-2 bg-[color:var(--sel)] text-white disabled:opacity-50 hover:opacity-90 transition">
                    {loading ? 'Sendi‚Ä¶' : 'Senda'}
                  </button>
                </div>
                <p className="text-[12px] text-[color:var(--muted)] mt-2">V√≠sbending: √û√∫ getur svara√∞ t.d. ‚Äû√âg held a√∞ √æau l√¶ri st√¶r√∞fr√¶√∞i af √æv√≠ a√∞ t√∂lur eru √° t√∂flunni.‚Äú</p>
              </div>
            </div>
          </section>

          <footer className="pt-4 text-[13px] text-[color:var(--muted)]">
            <p>Gervigreind: gpt-4o ¬∑ hitastig 0.7 ¬∑ max 300 tokens. M√°lfarsendurgj√∂f er v√¶g og birtist √≠ bl√°rri bobblu.</p>
          </footer>
        </main>
      );
    }

    ReactDOM.createRoot(document.getElementById('app')).render(<App/>);
  </script>
</body>
</html>
