<!DOCTYPE html>
<html lang="is">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>üéß Hlustunar√¶fing ‚Äì M√°lst√∂√∞in</title>
  <script src="lesson-config.js"></script>
  <script src="lesson-navigation.js"></script>
  <script crossorigin src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
  <script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
  <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
  <script src="https://cdn.tailwindcss.com"></script>
  <style>
    body {
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', system-ui, sans-serif;
      background: linear-gradient(to bottom, #f8f7f4 0%, #e8e6e1 100%);
      min-height: 100vh;
    }
    .clip-item {
      transition: all 0.2s;
    }
    .clip-item:hover {
      transform: translateX(4px);
    }
    .clip-completed { background: #e8f5e9; border-color: #4caf50; }
    .clip-current { background: #e3f2fd; border-color: #2196f3; }
    .clip-locked { opacity: 0.5; cursor: not-allowed; }
    
    .media-container {
      max-width: 500px;
      margin: 0 auto;
      width: 100%;
    }
    
    .media-container video,
    .media-container audio {
      width: 100%;
      border-radius: 12px;
    }
    
    .media-container video {
      height: auto;
      background: #000;
    }
    
    @media (max-width: 640px) {
      .media-container {
        max-width: 100%;
      }
    }
    
    .answer-option {
      border: 2px solid #e0e0e0;
      transition: all 0.2s;
    }
    .answer-option:hover:not(.disabled) {
      border-color: #2196f3;
      background: #e3f2fd;
    }
    .answer-option.selected {
      border-color: #2196f3;
      background: #e3f2fd;
    }
    .answer-option.correct {
      border-color: #4caf50;
      background: #e8f5e9;
    }
    .answer-option.incorrect {
      border-color: #f44336;
      background: #ffebee;
    }
  </style>
</head>
<body>
  <div id="root"></div>

  <script type="text/babel">
    const { useState, useEffect } = React;

    async function callOpenAI(payload) {
      const r = await fetch('/.netlify/functions/openai', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify(payload),
      });
      const data = await r.json();
      if (!r.ok || data.error) throw new Error(data.error || `HTTP ${r.status}`);
      return data.content;
    }

    // Clip data
    const CLIPS = [
      {
        id: 1,
        title: 'Kynning',
        type: 'translation',
        mediaUrl: 'videos/hlustun-1.mp4',
        mediaType: 'video',
        text: 'Hall√≥! √âg heiti Anna. √âg er fr√° √ökra√≠nu.',
        icon: 'üëã',
        difficulty: 'easy'
      },
      {
        id: 2,
        title: 'B√∫seta',
        type: 'translation',
        mediaUrl: 'videos/hlustun-2.mp4',
        mediaType: 'video',
        text: '√âg b√Ω √≠ Reykjav√≠k. √âg tala √≠slensku og ensku.',
        icon: 'üè†',
        difficulty: 'easy'
      },
      {
        id: 3,
        title: 'Vinna',
        type: 'translation',
        mediaUrl: 'videos/hlustun-3.mp4',
        mediaType: 'video',
        text: '√âg vinn √° leiksk√≥la. √âg elska starfi√∞ mitt.',
        icon: 'üë®‚Äçüè´',
        difficulty: 'easy'
      },
      {
        id: 4,
        title: 'Morgunr√∫t√≠na',
        type: 'multiple_choice',
        mediaUrl: 'videos/hlustun-4.mp4',
        mediaType: 'video',
        text: '√Å morgnana drekk √©g kaffi. √âg bor√∞a l√≠ka brau√∞. S√≠√∞an fer √©g √≠ vinnuna klukkan √°tta.',
        icon: '‚òï',
        difficulty: 'medium',
        questions: [
          {
            question: 'Hva√∞ drekkur Anna √° morgnana?',
            options: ['Te', 'Kaffi', 'Vatn', 'Mj√≥lk'],
            correct: 1
          },
          {
            question: 'Hven√¶r fer Anna √≠ vinnuna?',
            options: ['Klukkan sj√∂', 'Klukkan √°tta', 'Klukkan n√≠u', 'Klukkan t√≠u'],
            correct: 1
          }
        ]
      },
      {
        id: 5,
        title: 'Eftir vinnu',
        type: 'multiple_choice',
        mediaUrl: 'videos/hlustun-5.mp3',
        mediaType: 'audio',
        text: 'Eftir vinnu fer √©g √≠ l√≠kamsr√¶kt. Stundum fer √©g √° kaffih√∫s me√∞ vinum.',
        icon: 'üí™',
        difficulty: 'medium',
        questions: [
          {
            question: 'Hva√∞ gerir Anna eftir vinnu?',
            options: ['Fer heim', 'Fer √≠ b√≠√≥', 'Fer √≠ l√≠kamsr√¶kt', 'Les b√≥k'],
            correct: 2
          },
          {
            question: 'Me√∞ hverjum fer Anna √° kaffih√∫s?',
            options: ['Fj√∂lskyldu', 'Vinum', 'Kennurum', 'Ein'],
            correct: 1
          }
        ]
      },
      {
        id: 6,
        title: 'Helgar√°√¶tlanir',
        type: 'multiple_choice',
        mediaUrl: 'videos/hlustun-6.mp3',
        mediaType: 'audio',
        text: 'Um helgar vil √©g fara √∫t √≠ n√°tt√∫runa. √âg elska a√∞ taka myndir af fj√∂llum og d√Ωrum. √çslensk n√°tt√∫ra er mj√∂g falleg.',
        icon: 'üèîÔ∏è',
        difficulty: 'medium',
        questions: [
          {
            question: 'Hva√∞ vill Anna gera um helgar?',
            options: ['Vinna', 'Fara √∫t √≠ n√°tt√∫runa', 'Sofa', 'Horfa √° sj√≥nvarp'],
            correct: 1
          },
          {
            question: 'Hva√∞ tekur Anna myndir af?',
            options: ['F√≥lki', 'Mat', 'Fj√∂llum og d√Ωrum', 'H√∫sum'],
            correct: 2
          },
          {
            question: 'Hva√∞ finnst √ñnnu um √≠slensku n√°tt√∫runa?',
            options: ['Lei√∞inleg', 'Erfi√∞', 'Falleg', 'D√Ωr'],
            correct: 2
          }
        ]
      },
      {
        id: 7,
        title: '√ç b√≥kasafninu',
        type: 'multiple_choice',
        mediaUrl: 'videos/hlustun-7.mp3',
        mediaType: 'audio',
        text: 'H√¶! √âg er √≠ b√≥kasafninu. √âg vil lesa b√≥k um s√∂gu √çslands. Lest √æ√∫ miki√∞? √âg les alla daga heima.',
        icon: 'üìö',
        difficulty: 'medium',
        questions: [
          {
            question: 'Hvar er Anna?',
            options: ['Heima', '√ç b√≥kasafninu', '√ç sk√≥lanum', '√ç b√≠√≥'],
            correct: 1
          },
          {
            question: 'Um hva√∞ vill Anna lesa?',
            options: ['N√°tt√∫ru', 'Mat', 'S√∂gu √çslands', 'T√≥nlist'],
            correct: 2
          },
          {
            question: 'Hversu oft les Anna?',
            options: ['Stundum', 'Aldrei', 'Um helgar', 'Alla daga'],
            correct: 3
          }
        ]
      },
      {
        id: 8,
        title: '√Åhugam√°l',
        type: 'multiple_choice',
        mediaUrl: 'videos/hlustun-8.mp3',
        mediaType: 'audio',
        text: '√âg er a√∞ l√¶ra √≠slensku n√∫na. √çslenska er erfi√∞ en skemmtileg. √âg skil miki√∞ en tala ekki miki√∞ enn√æ√°. √âg √¶fi me√∞ vinum m√≠num.',
        icon: 'üìñ',
        difficulty: 'hard',
        questions: [
          {
            question: 'Hva√∞ er Anna a√∞ l√¶ra?',
            options: ['Ensku', 'Sp√¶nsku', '√çslensku', '√û√Ωsku'],
            correct: 2
          },
          {
            question: 'Hva√∞ finnst √ñnnu um √≠slensku?',
            options: ['Au√∞veld', 'Erfi√∞ en skemmtileg', 'Lei√∞inleg', 'Of erfi√∞'],
            correct: 1
          },
          {
            question: 'Me√∞ hverjum √¶fir Anna √≠slensku?',
            options: ['Kennara', 'Fj√∂lskyldu', 'Vinum', 'Ein'],
            correct: 2
          }
        ]
      },
      {
        id: 9,
        title: 'Dagur √ñnnu',
        type: 'multiple_choice',
        mediaUrl: 'videos/hlustun-9.mp3',
        mediaType: 'audio',
        text: 'G√≥√∞an daginn! √ç dag er f√∂studagur. √âg vakna klukkan sj√∂. Fyrst drekk √©g kaffi og horfi √° fr√©ttir. S√≠√∞an fer √©g √≠ vinnuna √° leiksk√≥lann. Vi√∞ lesum b√¶kur og leikum me√∞ b√∂rnunum. Eftir vinnu fer √©g √≠ sund. Svo fer √©g heim og elda mat.',
        icon: 'üìÖ',
        difficulty: 'hard',
        questions: [
          {
            question: 'Hva√∞a dagur er √≠ dag?',
            options: ['M√°nudagur', 'Mi√∞vikudagur', 'F√∂studagur', 'Laugardagur'],
            correct: 2
          },
          {
            question: 'Hva√∞ gerir Anna fyrst √° morgnana?',
            options: ['Fer √≠ vinnuna', 'Drekkur kaffi', 'Fer √≠ sund', 'Eldar mat'],
            correct: 1
          },
          {
            question: 'Hva√∞ gerir Anna me√∞ b√∂rnunum?',
            options: ['Les b√¶kur og leikur', 'Hleypur', 'Horfir √° sj√≥nvarp', 'Sefur'],
            correct: 0
          },
          {
            question: 'Hva√∞ gerir Anna eftir vinnu?',
            options: ['Fer √≠ b√≠√≥', 'Fer heim strax', 'Fer √≠ sund', 'Fer a√∞ sofa'],
            correct: 2
          }
        ]
      },
      {
        id: 10,
        title: 'Helgin',
        type: 'multiple_choice',
        mediaUrl: 'videos/hlustun-10.mp3',
        mediaType: 'audio',
        text: 'Um helgar er gaman. √Å laugard√∂gum sef √©g lengi. S√≠√∞an fer √©g √≠ b√¶inn og versla. √âg kaupi mat og stundum b√¶kur. √Å sunnud√∂gum fer √©g oft √≠ g√∂ngut√∫r me√∞ vinum. Vi√∞ f√∂rum √≠ Hei√∞m√∂rk e√∞a a√∞ Tj√∂rninni. Eftir g√∂ngut√∫rinn f√∂rum vi√∞ √° kaffih√∫s. √ûar drekkum vi√∞ kaffi og spj√∂llum. Helgar eru fr√°b√¶rar!',
        icon: 'üéâ',
        difficulty: 'hard',
        questions: [
          {
            question: 'Hva√∞ gerir Anna √° laugard√∂gum?',
            options: ['Fer √≠ vinnuna', 'Sefur lengi', 'Fer √≠ kirkju', 'Fer √≠ b√≠√≥'],
            correct: 1
          },
          {
            question: 'Hva√∞ kaupir Anna √≠ b√¶num?',
            options: ['F√∂t', 'T√∂lvu', 'Mat og stundum b√¶kur', 'B√≠l'],
            correct: 2
          },
          {
            question: 'Hva√∞ gerir Anna √° sunnud√∂gum?',
            options: ['Vinnur', 'Sefur alla daginn', 'Fer √≠ g√∂ngut√∫r', 'Les heima'],
            correct: 2
          },
          {
            question: 'Hvert fara Anna og vinir hennar?',
            options: ['√ç Hei√∞m√∂rk e√∞a a√∞ Tj√∂rninni', '√ç b√≠√≥', '√ç sundlaug', 'Heim til √ñnnu'],
            correct: 0
          },
          {
            question: 'Hva√∞ gera √æau √° kaffih√∫sinu?',
            options: ['Vinna', 'Lesa', 'Drekka kaffi og spjalla', 'Sofa'],
            correct: 2
          }
        ]
      }
    ];

    const Hlustun = () => {
      const [view, setView] = useState('list');
      const [currentClipId, setCurrentClipId] = useState(1);
      const [completedClips, setCompletedClips] = useState([]);
      const [clipResults, setClipResults] = useState({});
      const [lessonInfo, setLessonInfo] = useState(null);
      const [savedLanguage, setSavedLanguage] = useState('English');

      useEffect(() => {
        const info = getLessonInfo('hlustun');
        setLessonInfo(info);
        
        const saved = localStorage.getItem('userLanguage') || 'English';
        setSavedLanguage(saved);

        const saved_completed = localStorage.getItem('hlustun_completed');
        if (saved_completed) {
          setCompletedClips(JSON.parse(saved_completed));
        }

        const saved_results = localStorage.getItem('hlustun_results');
        if (saved_results) {
          setClipResults(JSON.parse(saved_results));
        }
      }, []);

      const startClip = (clipId) => {
        setCurrentClipId(clipId);
        setView('clip');
      };

      const completeClip = (clipId, result) => {
        const newCompleted = [...new Set([...completedClips, clipId])];
        setCompletedClips(newCompleted);
        localStorage.setItem('hlustun_completed', JSON.stringify(newCompleted));

        const newResults = { ...clipResults, [clipId]: result };
        setClipResults(newResults);
        localStorage.setItem('hlustun_results', JSON.stringify(newResults));

        if (clipId < CLIPS.length) {
          setCurrentClipId(clipId + 1);
        } else {
          setView('list');
        }
      };

      const backToList = () => {
        setView('list');
      };

      const resetProgress = () => {
        if (confirm('Ertu viss um a√∞ √æ√∫ viljir n√∫llstilla framvinduna?')) {
          setCompletedClips([]);
          setClipResults({});
          localStorage.removeItem('hlustun_completed');
          localStorage.removeItem('hlustun_results');
          setView('list');
        }
      };

      const currentClip = CLIPS.find(c => c.id === currentClipId);

      return (
        <div className="min-h-screen pb-12">
          <header className="bg-white shadow-sm border-b border-gray-200">
            <div className="max-w-4xl mx-auto px-6 py-8">
              <button 
                onClick={() => window.history.back()} 
                className="text-sm text-gray-500 hover:text-gray-700 mb-2 inline-block font-light"
              >
                ‚Üê Til baka
              </button>
              <h1 className="text-3xl font-light text-gray-800 mb-2">Hlustunar√¶fing</h1>
              <p className="text-gray-500 text-sm font-light">Hlusta og √¶fa ¬∑ A1</p>
            </div>
          </header>

          <main className="max-w-4xl mx-auto px-6 mt-8">
            <div className="bg-white rounded-lg shadow-sm p-6 mb-6">
              <div className="flex items-center justify-between">
                <p className="text-sm text-gray-600 font-light">
                  üåç M√≥√∞urm√°l: <strong>{savedLanguage}</strong>
                </p>
                <a 
                  href="byrjun.html" 
                  className="text-sm text-blue-600 hover:underline font-light"
                >
                  Breyta
                </a>
              </div>
            </div>

            {view === 'list' ? (
              <ClipList 
                clips={CLIPS}
                completedClips={completedClips}
                clipResults={clipResults}
                onStartClip={startClip}
                onReset={resetProgress}
              />
            ) : (
              <ClipExercise
                key={currentClipId}
                clip={currentClip}
                onComplete={completeClip}
                onBack={backToList}
                savedLanguage={savedLanguage}
              />
            )}

            {view === 'list' && lessonInfo && (
              <>
                <div className="flex justify-between gap-4 mt-8 mb-6">
                  {lessonInfo.prev ? (
                    <a 
                      href={lessonInfo.prev.url}
                      className="flex-1 px-6 py-3 bg-white border-2 border-gray-200 rounded-lg text-gray-700 hover:border-blue-500 hover:text-blue-600 transition-all text-center font-light"
                    >
                      ‚Üê {lessonInfo.prev.name}
                    </a>
                  ) : (
                    <a 
                      href="byrjun.html"
                      className="flex-1 px-6 py-3 bg-white border-2 border-gray-200 rounded-lg text-gray-700 hover:border-blue-500 hover:text-blue-600 transition-all text-center font-light"
                    >
                      ‚Üê Til baka
                    </a>
                  )}
                  
                  {lessonInfo.next ? (
                    <a 
                      href={lessonInfo.next.url}
                      className="flex-1 px-6 py-3 bg-gray-800 text-white rounded-lg hover:bg-gray-700 transition-all text-center font-light"
                    >
                      {lessonInfo.next.name} ‚Üí
                    </a>
                  ) : (
                    <a 
                      href="byrjun.html"
                      className="flex-1 px-6 py-3 bg-gradient-to-r from-green-500 to-green-600 text-white rounded-lg hover:from-green-600 hover:to-green-700 transition-all text-center font-light"
                    >
                      üéâ Kl√°ra√∞!
                    </a>
                  )}
                </div>

                <div className="bg-white rounded-lg shadow-sm p-6 mb-6 border border-gray-200">
                  <div className="flex justify-between items-center mb-3">
                    <span className="text-sm text-gray-600 font-light">
                      Skref {lessonInfo.index + 1} af {lessonInfo.total}
                    </span>
                    <span className="text-lg text-blue-600 font-medium">
                      {Math.round(((lessonInfo.index + 1) / lessonInfo.total) * 100)}%
                    </span>
                  </div>
                  <div className="w-full h-2 bg-gray-200 rounded-full overflow-hidden mb-4">
                    <div 
                      className="h-full bg-gradient-to-r from-blue-500 to-blue-600 rounded-full transition-all duration-500"
                      style={{ width: `${((lessonInfo.index + 1) / lessonInfo.total) * 100}%` }}
                    ></div>
                  </div>
                  <div className="flex gap-2 mb-3">
                    {LESSON_CONFIG.lessons.map((lesson, i) => (
                      <div 
                        key={lesson.id}
                        className={`flex-1 h-3 rounded-full transition-all ${
                          i < lessonInfo.index ? 'bg-green-500' :
                          i === lessonInfo.index ? 'bg-blue-500' :
                          'bg-gray-200'
                        }`}
                      ></div>
                    ))}
                  </div>
                  <div className="flex flex-wrap gap-2 text-xs text-gray-500">
                    {LESSON_CONFIG.lessons.map((lesson, i) => (
                      <React.Fragment key={lesson.id}>
                        <span className={`${
                          i < lessonInfo.index ? 'text-green-600 font-medium' :
                          i === lessonInfo.index ? 'text-blue-600 font-semibold' :
                          'text-gray-400'
                        }`}>
                          {lesson.icon} {lesson.name}
                        </span>
                        {i < LESSON_CONFIG.lessons.length - 1 && <span className="text-gray-300">‚Üí</span>}
                      </React.Fragment>
                    ))}
                  </div>
                </div>
              </>
            )}
          </main>
        </div>
      );
    };

    const ClipList = ({ clips, completedClips, clipResults, onStartClip, onReset }) => {
      const totalCompleted = completedClips.length;
      const percentage = Math.round((totalCompleted / clips.length) * 100);

      return (
        <div className="bg-white rounded-lg shadow-sm p-8">
          <div className="text-center mb-8">
            <div className="text-6xl mb-4">üéß</div>
            <h2 className="text-2xl font-light text-gray-800 mb-4">Veldu klippu</h2>
            <p className="text-gray-600 font-light mb-6">
              √û√∫ hefur kl√°ra√∞ {totalCompleted} af {clips.length} klippum ({percentage}%)
            </p>
            
            <div className="w-full max-w-md mx-auto h-3 bg-gray-200 rounded-full overflow-hidden mb-8">
              <div 
                className="h-full bg-gradient-to-r from-blue-500 to-blue-600 rounded-full transition-all duration-500"
                style={{ width: `${percentage}%` }}
              ></div>
            </div>
          </div>

          <div className="space-y-3 mb-8">
            {clips.map((clip, index) => {
              const isCompleted = completedClips.includes(clip.id);
              const isCurrent = !isCompleted && (index === 0 || completedClips.includes(clips[index - 1].id));
              const isLocked = !isCurrent && !isCompleted;
              const result = clipResults[clip.id];

              return (
                <div
                  key={clip.id}
                  onClick={() => !isLocked && onStartClip(clip.id)}
                  className={`clip-item p-4 rounded-lg border-2 cursor-pointer ${
                    isCompleted ? 'clip-completed' :
                    isCurrent ? 'clip-current' :
                    'clip-locked'
                  }`}
                >
                  <div className="flex items-center gap-4">
                    <div className="text-3xl">{clip.icon}</div>
                    <div className="flex-1">
                      <div className="flex items-center gap-2 mb-1">
                        <h3 className="font-normal text-gray-800">
                          {clip.id}. {clip.title}
                        </h3>
                        {isCompleted && <span className="text-green-600">‚úÖ</span>}
                        {isCurrent && <span className="text-blue-600">üîµ</span>}
                        {isLocked && <span className="text-gray-400">üîí</span>}
                      </div>
                      <p className="text-sm text-gray-500 font-light">
                        {clip.type === 'translation' ? '√û√Ω√∞ing' : 'Spurningar'} ¬∑ 
                        {clip.difficulty === 'easy' ? ' Au√∞velt' : clip.difficulty === 'medium' ? ' Mi√∞lungs' : ' Erfitt'}
                        {clip.mediaType === 'video' && ' ¬∑ üé• V√≠de√≥'}
                      </p>
                      {result && (
                        <p className="text-sm text-gray-600 mt-1">
                          Ni√∞ursta√∞a: {result.score !== undefined ? `${result.score}%` : result.correct ? '‚úÖ R√©tt' : '‚ùå Rangt'}
                        </p>
                      )}
                    </div>
                    <div>
                      {!isLocked && (
                        <span className="text-blue-600 font-light">‚Üí</span>
                      )}
                    </div>
                  </div>
                </div>
              );
            })}
          </div>

          {totalCompleted > 0 && (
            <div className="text-center">
              <button
                onClick={onReset}
                className="text-sm text-gray-500 hover:text-gray-700 underline font-light"
              >
                N√∫llstilla framvindu
              </button>
            </div>
          )}
        </div>
      );
    };

    const ClipExercise = ({ clip, onComplete, onBack, savedLanguage }) => {
      const [userAnswer, setUserAnswer] = useState('');
      const [selectedAnswers, setSelectedAnswers] = useState([]);
      const [showFeedback, setShowFeedback] = useState(false);
      const [isCorrect, setIsCorrect] = useState(false);
      const [loading, setLoading] = useState(false);
      const [feedbackData, setFeedbackData] = useState(null);

      const handleSubmit = async () => {
        setLoading(true);

        if (clip.type === 'translation') {
          try {
            const sys = `
√û√∫ ert √≠slenskukennari sem metur √æ√Ω√∞ingar nemenda.

UPPRUNALEGI TEXTINN (√≠slenska):
"${clip.text}"

NEMANDI √û√ùDDI √Å ${savedLanguage}:
"${userAnswer}"

VERKEFNI:
Meta hvort √æ√Ω√∞ingin er r√©tt. Sam√æykkja:
- N√°kv√¶mar √æ√Ω√∞ingar
- √û√Ω√∞ingar me√∞ r√©ttri merkingu (jafnvel ef or√∞alag er √∂√∞ruv√≠si)
- Minnih√°ttar m√°lfr√¶√∞ivillur √≠ m√≥√∞urm√°li (vi√∞ erum a√∞ meta √≠slensku skilning!)
- √û√Ω√∞ingar sem sleppa "Hall√≥/H√¶" √≠ byrjun (ekki nau√∞synlegt)

HAFNA:
- Ef st√≥r hluti vantar
- Ef merkingin er r√∂ng
- Ef auglj√≥st a√∞ nemandi skildi ekki textann

SKILA√êU JSON (BARA JSON, EKKERT ANNA√ê):
{
  "correct": boolean,
  "feedback_is": "Stuttleg endurgj√∂f √° √≠slensku",
  "feedback_native": "Stuttleg endurgj√∂f √° ${savedLanguage}",
  "correct_translation": "G√≥√∞ √æ√Ω√∞ing √° ${savedLanguage} (ef rangt, annars null)"
}

D√ÜMI um g√≥√∞ar √æ√Ω√∞ingar √° ensku:
- "Hello! My name is Anna. I am from Ukraine."
- "Hi! I'm Anna. I'm from Ukraine."
- "My name is Anna and I am from Ukraine."

Vertu hvetjandi og j√°kv√¶√∞ur!
`.trim();

            const response = await callOpenAI({
              model: 'gpt-4o',
              temperature: 0.3,
              max_tokens: 300,
              messages: [
                { role: 'system', content: sys },
                { role: 'user', content: 'Meta √æ√Ω√∞ingu' }
              ]
            });

            let cleanResponse = response
              .replace(/```json\n?/g, '')
              .replace(/```\n?/g, '')
              .replace(/^[^{]*/g, '')
              .replace(/[^}]*$/g, '')
              .trim();

            const data = JSON.parse(cleanResponse);
            setFeedbackData(data);
            setIsCorrect(data.correct);
            setShowFeedback(true);

            if (data.correct) {
              setTimeout(() => {
                onComplete(clip.id, { correct: true, translation: userAnswer });
              }, 2500);
            }
          } catch (e) {
            console.error('Translation evaluation error:', e);
            alert('Villa vi√∞ a√∞ meta √æ√Ω√∞ingu. Reyndu aftur.');
          } finally {
            setLoading(false);
          }
        } else {
          const allCorrect = clip.questions.every((q, i) => selectedAnswers[i] === q.correct);
          const correctCount = clip.questions.filter((q, i) => selectedAnswers[i] === q.correct).length;
          const score = Math.round((correctCount / clip.questions.length) * 100);
          
          setIsCorrect(allCorrect);
          setShowFeedback(true);
          setLoading(false);
          
          setTimeout(() => {
            onComplete(clip.id, { score, answers: selectedAnswers });
          }, 3000);
        }
      };

      const handleOptionSelect = (questionIndex, optionIndex) => {
        if (showFeedback) return;
        const newAnswers = [...selectedAnswers];
        newAnswers[questionIndex] = optionIndex;
        setSelectedAnswers(newAnswers);
      };

      const canSubmit = clip.type === 'translation'
        ? userAnswer.trim().length > 5
        : selectedAnswers.length === clip.questions?.length;

      return (
        <div className="bg-white rounded-lg shadow-sm p-8">
          <div className="mb-6">
            <button
              onClick={onBack}
              className="text-sm text-gray-500 hover:text-gray-700 font-light mb-4"
            >
              ‚Üê Til baka √≠ lista
            </button>
            <div className="flex items-center gap-3 mb-2">
              <span className="text-4xl">{clip.icon}</span>
              <h2 className="text-2xl font-light text-gray-800">
                {clip.id}. {clip.title}
              </h2>
            </div>
            <p className="text-gray-500 text-sm font-light">
              {clip.mediaType === 'video' ? 'Horf√∞u og ' : 'Hlusta og '}
              {clip.type === 'translation' ? '√æ√Ω√∞a √° √æitt m√≥√∞urm√°l' : 'svara spurningum'}
            </p>
          </div>

          <div className="text-center mb-8">
            <div className="media-container">
              {clip.mediaType === 'video' ? (
                <video key={clip.id} controls>
                  <source src={clip.mediaUrl} type="video/mp4" />
                  Vafrinn √æinn sty√∞ur ekki v√≠de√≥.
                </video>
              ) : (
                <audio key={clip.id} controls>
                  <source src={clip.mediaUrl} type="audio/mpeg" />
                  Vafrinn √æinn sty√∞ur ekki audio.
                </audio>
              )}
            </div>
            <p className="text-sm text-gray-500 mt-4 font-light">
              üí° √û√∫ getur {clip.mediaType === 'video' ? 'horft' : 'hlusta√∞'} √° klippuna eins oft og √æ√∫ vilt
            </p>
          </div>

          {clip.type === 'translation' ? (
            <div className="mb-8">
              <label className="block text-gray-700 font-normal mb-3">
                üåç √û√Ω√∞ing √° {savedLanguage}:
              </label>
              <textarea
                value={userAnswer}
                onChange={(e) => setUserAnswer(e.target.value)}
                disabled={showFeedback || loading}
                className="w-full p-4 border-2 border-gray-200 rounded-lg focus:border-blue-500 focus:outline-none font-light text-lg"
                rows="3"
                placeholder={`√û√Ωddu √° ${savedLanguage}...`}
              />
              <p className="text-xs text-gray-500 mt-2 font-light">
                üí° Skrifa√∞u hva√∞ √æ√∫ {clip.mediaType === 'video' ? 'heyr√∞ir' : 'heyr√∞ir'} √° √æ√≠nu m√≥√∞urm√°li
              </p>
            </div>
          ) : (
            <div className="space-y-6 mb-8">
              {clip.questions?.map((question, qIndex) => (
                <div key={qIndex} className="border-2 border-gray-100 rounded-lg p-4">
                  <p className="font-normal text-gray-800 mb-4">
                    {qIndex + 1}. {question.question}
                  </p>
                  <div className="space-y-2">
                    {question.options.map((option, oIndex) => {
                      const isSelected = selectedAnswers[qIndex] === oIndex;
                      const isCorrectAnswer = oIndex === question.correct;
                      const showAsCorrect = showFeedback && isCorrectAnswer;
                      const showAsIncorrect = showFeedback && isSelected && !isCorrectAnswer;

                      return (
                        <div
                          key={oIndex}
                          onClick={() => handleOptionSelect(qIndex, oIndex)}
                          className={`answer-option p-3 rounded-lg cursor-pointer ${
                            isSelected && !showFeedback ? 'selected' : ''
                          } ${showAsCorrect ? 'correct' : ''} ${showAsIncorrect ? 'incorrect' : ''} ${
                            showFeedback ? 'disabled' : ''
                          }`}
                        >
                          <div className="flex items-center gap-3">
                            <div className={`w-5 h-5 rounded-full border-2 flex items-center justify-center ${
                              isSelected ? 'border-blue-500 bg-blue-500' : 'border-gray-300'
                            }`}>
                              {isSelected && <div className="w-2 h-2 bg-white rounded-full"></div>}
                            </div>
                            <span className="font-light">{option}</span>
                            {showAsCorrect && <span className="ml-auto text-green-600">‚úÖ</span>}
                            {showAsIncorrect && <span className="ml-auto text-red-600">‚ùå</span>}
                          </div>
                        </div>
                      );
                    })}
                  </div>
                </div>
              ))}
            </div>
          )}

          {showFeedback && (
            <div className={`p-6 rounded-lg mb-6 ${
              isCorrect ? 'bg-green-50 border-2 border-green-200' : 'bg-red-50 border-2 border-red-200'
            }`}>
              <div className="flex items-start gap-3">
                <span className="text-3xl">{isCorrect ? 'üéâ' : 'üí™'}</span>
                <div className="flex-1">
                  <h3 className="font-normal text-gray-800 mb-2">
                    {isCorrect ? 'Fr√°b√¶rt!' : 'G√≥√∞ tilraun!'}
                  </h3>
                  
                  {clip.type === 'translation' && feedbackData && (
                    <div>
                      <p className="text-sm text-gray-700 mb-2 font-light">
                        <strong>√çslenska:</strong> {feedbackData.feedback_is}
                      </p>
                      <p className="text-sm text-gray-700 mb-3 font-light">
                        <strong>{savedLanguage}:</strong> {feedbackData.feedback_native}
                      </p>
                      {!isCorrect && feedbackData.correct_translation && (
                        <div className="bg-white p-3 rounded mt-3">
                          <p className="text-xs text-gray-500 mb-1">G√≥√∞ √æ√Ω√∞ing:</p>
                          <p className="font-normal text-gray-800">{feedbackData.correct_translation}</p>
                        </div>
                      )}
                    </div>
                  )}
                  
                  <p className="text-sm text-gray-600 font-light mt-3">
                    {isCorrect 
                      ? '√û√∫ heldur sj√°lfkrafa √°fram eftir 2-3 sek√∫ndur...'
                      : 'Pr√≥fa√∞u aftur e√∞a far√∞u √°fram √≠ n√¶stu klippu.'}
                  </p>
                </div>
              </div>
            </div>
          )}

          {!showFeedback && (
            <div className="text-center">
              <button
                onClick={handleSubmit}
                disabled={!canSubmit || loading}
                className="bg-gray-800 text-white px-8 py-3 rounded-md hover:bg-gray-700 disabled:bg-gray-300 disabled:cursor-not-allowed transition-colors font-light text-lg"
              >
                {loading ? 'Athuga...' : 'Athuga svar'}
              </button>
            </div>
          )}

          {showFeedback && !isCorrect && (
            <div className="text-center mt-4">
              <button
                onClick={() => onComplete(clip.id, { correct: false })}
                className="text-blue-600 hover:underline font-light"
              >
                Halda √°fram √≠ n√¶stu klippu ‚Üí
              </button>
            </div>
          )}
        </div>
      );
    };

    ReactDOM.createRoot(document.getElementById('root')).render(<Hlustun />);
  </script>
</body>
</html>
