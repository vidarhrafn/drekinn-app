<!DOCTYPE html>
<html lang="is">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>üìù Ey√∞ufylling ‚Äì M√°lst√∂√∞in</title>
  <script src="lesson-config.js"></script>
  <script src="lesson-navigation.js"></script>
  <script crossorigin src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
  <script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
  <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
  <script src="https://cdn.tailwindcss.com"></script>
  <style>
    body {
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', system-ui, sans-serif;
      background: linear-gradient(to bottom, #f8f7f4 0%, #e8e6e1 100%);
      min-height: 100vh;
    }
    .input-blank {
      border-bottom: 2px solid #333;
      padding: 0.25rem 0.5rem;
      min-width: 100px;
      text-align: center;
      font-size: 1.1rem;
    }
    .input-blank:focus {
      outline: none;
      border-bottom-color: #1565c0;
    }
    .correct {
      border-bottom-color: #2e7d32;
      background-color: #e8f5e9;
    }
    .incorrect {
      border-bottom-color: #d32f2f;
      background-color: #ffebee;
    }
  </style>
</head>
<body>
  <div id="root"></div>

  <script type="text/babel">
    const { useState } = React;

    async function callOpenAI(payload) {
      const r = await fetch('/.netlify/functions/openai', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify(payload),
      });
      const data = await r.json();
      if (!r.ok || data.error) throw new Error(data.error || `HTTP ${r.status}`);
      return data.content;
    }

    const Eydufylling = () => {
      const [stage, setStage] = useState('intro');
      const [answers, setAnswers] = useState(['', '', '', '', '']);
      const [results, setResults] = useState(null);
      const [loading, setLoading] = useState(false);
      const [lessonInfo, setLessonInfo] = useState(null);
      const [savedLanguage, setSavedLanguage] = useState('English');

      React.useEffect(() => {
        // Get lesson info
        const info = getLessonInfo('eydufylling');
        setLessonInfo(info);
        
        // Get saved language
        const saved = localStorage.getItem('userLanguage') || 'English';
        setSavedLanguage(saved);
      }, []);

      // Textinn me√∞ ey√∞um
      const text = "√âg _____ Anna. √âg _____ fr√° Sv√≠√æj√≥√∞. √âg _____ √≠ Reykjav√≠k. √âg _____ √≠slensku og ensku. √âg _____ 25 √°ra.";
      const correctAnswers = ['heiti', 'er', 'b√Ω', 'tala', 'er'];

      const handleSubmit = async () => {
        setLoading(true);
        try {
          const sys = `
√û√∫ ert √≠slenskukennari sem metur ey√∞ufyllingar√¶fingar fyrir A1 nemendur.

VERKEFNI:
Notandinn √° a√∞ fylla √≠ 5 ey√∞ur √≠ √æessum texta:
"√âg _____ Anna. √âg _____ fr√° Sv√≠√æj√≥√∞. √âg _____ √≠ Reykjav√≠k. √âg _____ √≠slensku og ensku. √âg _____ 25 √°ra."

SVAR NOTANDA:
${answers.map((a, i) => `${i + 1}. ${a || '(t√≥mt)'}`).join('\n')}

MIKILV√ÜGT - SAM√ûYKKJA ALLA R√âTTA √çSLENSKU:
Mat √æitt √° a√∞ byggjast √°: "Er √æetta m√°lfr√¶√∞ilega r√©tt √≠slenska?"

Ey√∞a 1: "√âg _____ Anna"
- R√©tt: heiti, er, heitir (ef pers√≥nan heitir Anna), o.fl.
- "√âg er Anna" = I am Anna (FULLKOMLEGA R√âTT!)
- "√âg heiti Anna" = My name is Anna (FULLKOMLEGA R√âTT!)

Ey√∞a 2: "√âg _____ fr√° Sv√≠√æj√≥√∞"
- R√©tt: er, kem, kom, o.fl.
- √ñll √æessi or√∞ eru r√©tt √≠slenska!

Ey√∞a 3: "√âg _____ √≠ Reykjav√≠k"
- R√©tt: b√Ω, er, b√∫a (ef √æ√∫ ert a√∞ tala √≠ fleirt√∂lu), o.fl.
- √ñll √æessi or√∞ eru r√©tt √≠slenska!

Ey√∞a 4: "√âg _____ √≠slensku og ensku"
- R√©tt: tala, skil, l√¶ri, kann, o.fl.
- "√âg skil √≠slensku" = I understand Icelandic (R√âTT!)
- "√âg tala √≠slensku" = I speak Icelandic (R√âTT!)

Ey√∞a 5: "√âg _____ 25 √°ra"
- R√©tt: er
- √ûetta er eina r√©ttu svari√∞

SKILA√êU JSON:
{
  "items": [
    {"i": 0, "correct": boolean, "expected": null, "feedback": "Hr√≥s e√∞a mj√∫k lei√∞r√©tting"},
    ...
  ],
  "score_pct": number,
  "explain_overall": "Heildarendurgj√∂f"
}

REGLUR:
- Ef setningin er m√°lfr√¶√∞ilega r√©tt ‚Üí correct: true, hr√≥sa√∞u!
- Ef beygingin er r√©tt en or√∞i√∞ passar ekki √≠ samhenginu ‚Üí samt correct: true, en gef√∞u mild √°bending
- Ef t√≥mt ‚Üí correct: false, "√û√∫ gleymdir a√∞ fylla √æetta √∫t"
- Ef alveg r√∂ng m√°lfr√¶√∞i (t.d. "√©g eru") ‚Üí correct: false, √∫tsk√Ωr√∞u
- ALDREI sl√° √° fingur nemanda fyrir m√°lfr√¶√∞ilega r√©tt √≠slensku!
- Vertu MJ√ñG hvetjandi

MIKILV√ÜGT: Svari√∞ √æitt m√° BARA vera JSON. Ekkert anna√∞. Ekki texti fyrir framan e√∞a aftan.
`.trim();

          const response = await callOpenAI({
            model: 'gpt-4o',
            temperature: 0.3,
            max_tokens: 800,
            messages: [
              { role: 'system', content: sys },
              { role: 'user', content: 'Vinsamlegast mettu sv√∂rin m√≠n. SKILA√êU BARA JSON, EKKERT ANNA√ê.' }
            ]
          });

          // Clean response - remove markdown, extra text, etc.
          let cleanResponse = response
            .replace(/```json\n?/g, '')
            .replace(/```\n?/g, '')
            .replace(/^[^{]*/g, '')  // Remove everything before first {
            .replace(/[^}]*$/g, '')  // Remove everything after last }
            .trim();

          console.log('Clean response:', cleanResponse);
          
          const data = JSON.parse(cleanResponse);
          setResults(data);
          setStage('results');
        } catch (e) {
          console.error('Error:', e);
          alert('√öps, eitthva√∞ f√≥r √∫rskei√∞is. Reyndu aftur.');
        } finally {
          setLoading(false);
        }
      };

      const reset = () => {
        setStage('intro');
        setAnswers(['', '', '', '', '']);
        setResults(null);
      };

      return (
        <div className="min-h-screen pb-12">
          <header className="bg-white shadow-sm border-b border-gray-200">
            <div className="max-w-4xl mx-auto px-6 py-8">
              <button 
                onClick={() => window.history.back()} 
                className="text-sm text-gray-500 hover:text-gray-700 mb-2 inline-block font-light"
              >
                ‚Üê Til baka
              </button>
              <h1 className="text-3xl font-light text-gray-800 mb-2">Ey√∞ufylling</h1>
              <p className="text-gray-500 text-sm font-light">Grunnm√°lfr√¶√∞i√¶fing ¬∑ A1</p>
            </div>
          </header>

          <main className="max-w-4xl mx-auto px-6 mt-8">
            {/* Language Info */}
            <div className="bg-white rounded-lg shadow-sm p-6 mb-6">
              <div className="flex items-center justify-between">
                <p className="text-sm text-gray-600 font-light">
                  üåç M√≥√∞urm√°l: <strong>{savedLanguage}</strong>
                </p>
                <a 
                  href="byrjun.html" 
                  className="text-sm text-blue-600 hover:underline font-light"
                >
                  Breyta
                </a>
              </div>
            </div>

            {stage === 'intro' && (
              <div className="bg-white rounded-lg shadow-sm p-8">
                <div className="text-center mb-8">
                  <div className="text-6xl mb-4">üìù</div>
                  <h2 className="text-2xl font-light text-gray-800 mb-4">Fylltu √≠ ey√∞urnar</h2>
                  <p className="text-gray-600 font-light leading-relaxed max-w-xl mx-auto mb-6">
                    Lestu textann og fylltu √≠ ey√∞urnar me√∞ r√©ttum or√∞um. Nota√∞u r√©tta beygingu!
                  </p>
                </div>

                <div className="bg-gray-50 rounded-lg p-8 mb-8 text-center">
                  <p className="text-xl leading-relaxed text-gray-800">
                    √âg{' '}
                    <input
                      type="text"
                      className="input-blank"
                      value={answers[0]}
                      onChange={(e) => setAnswers([e.target.value, answers[1], answers[2], answers[3], answers[4]])}
                      placeholder="?"
                    />
                    {' '}Anna. √âg{' '}
                    <input
                      type="text"
                      className="input-blank"
                      value={answers[1]}
                      onChange={(e) => setAnswers([answers[0], e.target.value, answers[2], answers[3], answers[4]])}
                      placeholder="?"
                    />
                    {' '}fr√° Sv√≠√æj√≥√∞. √âg{' '}
                    <input
                      type="text"
                      className="input-blank"
                      value={answers[2]}
                      onChange={(e) => setAnswers([answers[0], answers[1], e.target.value, answers[3], answers[4]])}
                      placeholder="?"
                    />
                    {' '}√≠ Reykjav√≠k. √âg{' '}
                    <input
                      type="text"
                      className="input-blank"
                      value={answers[3]}
                      onChange={(e) => setAnswers([answers[0], answers[1], answers[2], e.target.value, answers[4]])}
                      placeholder="?"
                    />
                    {' '}√≠slensku og ensku. √âg{' '}
                    <input
                      type="text"
                      className="input-blank"
                      value={answers[4]}
                      onChange={(e) => setAnswers([answers[0], answers[1], answers[2], answers[3], e.target.value])}
                      placeholder="?"
                    />
                    {' '}25 √°ra.
                  </p>
                </div>

                <div className="text-center">
                  <button
                    onClick={handleSubmit}
                    disabled={loading || answers.every(a => !a.trim())}
                    className="bg-gray-800 text-white px-8 py-3 rounded-md hover:bg-gray-700 disabled:bg-gray-300 disabled:cursor-not-allowed transition-colors font-light text-lg"
                  >
                    {loading ? 'Athuga...' : 'Athuga sv√∂rin'}
                  </button>
                </div>
              </div>
            )}

            {stage === 'results' && results && (
              <div className="bg-white rounded-lg shadow-sm p-8">
                <div className="text-center mb-8">
                  <div className="text-6xl mb-4">
                    {results.score_pct >= 80 ? 'üéâ' : results.score_pct >= 60 ? 'üëç' : 'üí™'}
                  </div>
                  <h2 className="text-2xl font-light text-gray-800 mb-2">
                    √û√∫ f√©kkst {results.score_pct}%
                  </h2>
                  <p className="text-gray-600 font-light">{results.explain_overall}</p>
                </div>

                <div className="space-y-4 mb-8">
                  {results.items.map((item, idx) => (
                    <div
                      key={idx}
                      className={`p-4 rounded-lg border-2 ${
                        item.correct
                          ? 'bg-green-50 border-green-200'
                          : 'bg-red-50 border-red-200'
                      }`}
                    >
                      <div className="flex items-start gap-3">
                        <span className="text-2xl">
                          {item.correct ? '‚úÖ' : '‚ùå'}
                        </span>
                        <div className="flex-1">
                          <p className="font-normal text-gray-800 mb-1">
                            Ey√∞a {idx + 1}: <span className="font-mono">{answers[idx] || '(t√≥mt)'}</span>
                          </p>
                          {!item.correct && (
                            <p className="text-sm text-gray-600 mb-1">
                              R√©tt svar: <span className="font-mono font-semibold">{item.expected}</span>
                            </p>
                          )}
                          <p className="text-sm text-gray-600 font-light">{item.feedback}</p>
                        </div>
                      </div>
                    </div>
                  ))}
                </div>

                <div className="text-center">
                  <button
                    onClick={reset}
                    className="bg-gray-800 text-white px-8 py-3 rounded-md hover:bg-gray-700 transition-colors font-light"
                  >
                    Pr√≥fa aftur
                  </button>
                </div>
              </div>
            )}

            {/* Navigation Buttons */}
            {lessonInfo && (
              <div className="flex justify-between gap-4 mt-8 mb-6">
                {lessonInfo.prev ? (
                  <a 
                    href={lessonInfo.prev.url}
                    className="flex-1 px-6 py-3 bg-white border-2 border-gray-200 rounded-lg text-gray-700 hover:border-blue-500 hover:text-blue-600 transition-all text-center font-light"
                  >
                    ‚Üê {lessonInfo.prev.name}
                  </a>
                ) : (
                  <a 
                    href="byrjun.html"
                    className="flex-1 px-6 py-3 bg-white border-2 border-gray-200 rounded-lg text-gray-700 hover:border-blue-500 hover:text-blue-600 transition-all text-center font-light"
                  >
                    ‚Üê Til baka
                  </a>
                )}
                
                {lessonInfo.next ? (
                  <a 
                    href={lessonInfo.next.url}
                    className="flex-1 px-6 py-3 bg-gray-800 text-white rounded-lg hover:bg-gray-700 transition-all text-center font-light"
                  >
                    {lessonInfo.next.name} ‚Üí
                  </a>
                ) : (
                  <a 
                    href="byrjun.html"
                    className="flex-1 px-6 py-3 bg-gradient-to-r from-green-500 to-green-600 text-white rounded-lg hover:from-green-600 hover:to-green-700 transition-all text-center font-light"
                  >
                    üéâ Kl√°ra√∞!
                  </a>
                )}
              </div>
            )}

            {/* Progress Bar */}
            {lessonInfo && (
              <div className="bg-white rounded-lg shadow-sm p-6 mb-6 border border-gray-200">
                <div className="flex justify-between items-center mb-3">
                  <span className="text-sm text-gray-600 font-light">
                    Skref {lessonInfo.index + 1} af {lessonInfo.total}
                  </span>
                  <span className="text-lg text-blue-600 font-medium">
                    {Math.round(((lessonInfo.index + 1) / lessonInfo.total) * 100)}%
                  </span>
                </div>
                <div className="w-full h-2 bg-gray-200 rounded-full overflow-hidden mb-4">
                  <div 
                    className="h-full bg-gradient-to-r from-blue-500 to-blue-600 rounded-full transition-all duration-500"
                    style={{ width: `${((lessonInfo.index + 1) / lessonInfo.total) * 100}%` }}
                  ></div>
                </div>
                <div className="flex gap-2 mb-3">
                  {LESSON_CONFIG.lessons.map((lesson, i) => (
                    <div 
                      key={lesson.id}
                      className={`flex-1 h-3 rounded-full transition-all ${
                        i < lessonInfo.index ? 'bg-green-500' :
                        i === lessonInfo.index ? 'bg-blue-500' :
                        'bg-gray-200'
                      }`}
                    ></div>
                  ))}
                </div>
                <div className="flex flex-wrap gap-2 text-xs text-gray-500">
                  {LESSON_CONFIG.lessons.map((lesson, i) => (
                    <React.Fragment key={lesson.id}>
                      <span className={`${
                        i < lessonInfo.index ? 'text-green-600 font-medium' :
                        i === lessonInfo.index ? 'text-blue-600 font-semibold' :
                        'text-gray-400'
                      }`}>
                        {lesson.icon} {lesson.name}
                      </span>
                      {i < LESSON_CONFIG.lessons.length - 1 && <span className="text-gray-300">‚Üí</span>}
                    </React.Fragment>
                  ))}
                </div>
              </div>
            )}
          </main>
        </div>
      );
    };

    ReactDOM.createRoot(document.getElementById('root')).render(<Eydufylling />);
  </script>
</body>
</html>
