<!DOCTYPE html>
<html lang="is">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>üéß Hlustun ‚Äì √Üfing 1</title>
  <script crossorigin src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
  <script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
  <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
  <script src="https://cdn.tailwindcss.com"></script>
  <style>
    body {
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', system-ui, sans-serif;
      background: linear-gradient(to bottom, #f8f7f4 0%, #e8e6e1 100%);
      min-height: 100vh;
    }
  </style>
</head>
<body>
  <div id="root"></div>

  <script type="text/babel">
    const { useState, useRef } = React;

    const CORRECT_SENTENCE = "Vi√∞ f√∂rum √æarna til a√∞ kaupa brau√∞ e√∞a k√∂ku";
    const AUDIO_FILE = "/audio/setning1.wav";

    async function callOpenAI(payload) {
      const r = await fetch('/.netlify/functions/openai', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify(payload)
      });
      const data = await r.json();
      if (!r.ok || data.error) throw new Error(data.error || `HTTP ${r.status}`);
      return data.content;
    }

    const App = () => {
      const [userAnswer, setUserAnswer] = useState('');
      const [feedback, setFeedback] = useState(null);
      const [loading, setLoading] = useState(false);
      const audioRef = useRef(null);

      const playAudio = () => {
        if (audioRef.current) {
          audioRef.current.currentTime = 0;
          audioRef.current.play();
        }
      };

      const handleSubmit = async () => {
        const answer = userAnswer.trim();
        if (!answer) {
          setFeedback({
            correct: false,
            message: 'Vinsamlegast skrifa√∞u eitthva√∞ √°√∞ur en √æ√∫ √°tt a√∞ athuga svari√∞.'
          });
          return;
        }

        setLoading(true);
        setFeedback(null);

        try {
          const prompt = `√û√∫ ert kennari √≠ √≠slensku sem metur hvort nemandi hafi skrifa√∞ setningu r√©tt eftir a√∞ hafa hlusta√∞ √° hana.

R√âTT SETNING:
"${CORRECT_SENTENCE}"

SVAR NEMANDA:
"${answer}"

VERKEFNI:
1. Ber√∞u saman hvort nemandinn hafi skrifa√∞ setninguna N√ÅKV√ÜMLEGA R√âTT.
2. Setningin ver√∞ur a√∞ vera or√∞ fyrir or√∞ r√©tt, me√∞ r√©ttri stafsetningu og greinarmerkjum.
3. Hunsa√∞u minnih√°ttar greinamerkjamun (t.d. punktur √≠ lok e√∞a ekki).
4. Ef setningin er r√©tt, gef√∞u hvetjandi endurgj√∂f.
5. Ef setningin er r√∂ng, s√Ωndu nemandanum hvar mist√∂kin eru og r√©tta setninguna.

SVARA√êU A√êEINS ME√ê JSON √Å √ûESSU SNI√êI:
{
  "correct": true e√∞a false,
  "message": "√û√≠n endurgj√∂f h√©r (2-3 setningar)"
}

EKKERT ANNA√ê EN JSON.`;

          const result = await callOpenAI({
            messages: [{ role: 'user', content: prompt }],
            max_tokens: 300
          });

          // Clean result - strip markdown code blocks if present
          let cleanResult = result.trim();
          if (cleanResult.startsWith('```')) {
            cleanResult = cleanResult.replace(/```json\n?/g, '').replace(/```\n?/g, '').trim();
          }

          const parsed = JSON.parse(cleanResult);
          setFeedback(parsed);
        } catch (e) {
          console.error('Error:', e);
          setFeedback({
            correct: false,
            message: 'Villa kom upp vi√∞ a√∞ athuga svari√∞. Reyndu aftur.'
          });
        } finally {
          setLoading(false);
        }
      };

      const handleReset = () => {
        setUserAnswer('');
        setFeedback(null);
      };

      return (
        <div className="min-h-screen pb-12">
          <header className="bg-white shadow-sm border-b border-gray-200">
            <div className="max-w-4xl mx-auto px-6 py-8">
              <h1 className="text-3xl font-light text-gray-800 mb-2">Hlustun ‚Äì √Üfing 1</h1>
              <p className="text-gray-500 text-sm font-light">Hlusta√∞u og skrifa√∞u</p>
            </div>
          </header>

          <main className="max-w-4xl mx-auto px-6 mt-8">
            <section className="bg-white rounded-lg shadow-sm p-8">
              <div className="mb-8">
                <h2 className="text-xl font-light text-gray-800 mb-4">üìù Lei√∞beiningar</h2>
                <ol className="text-gray-600 space-y-2 font-light">
                  <li>1. Hlusta√∞u √° setninguna</li>
                  <li>2. Skrifa√∞u n√°kv√¶mlega √æa√∞ sem √æ√∫ heyrir</li>
                  <li>3. Smelltu √° "Athuga svar"</li>
                </ol>
              </div>

              {/* Audio player */}
              <div className="mb-8 p-6 bg-gray-50 rounded-lg">
                <audio ref={audioRef} src={AUDIO_FILE} preload="auto" />
                <button
                  onClick={playAudio}
                  className="w-full bg-gray-800 text-white px-6 py-4 rounded-md hover:bg-gray-700 transition-colors font-light flex items-center justify-center gap-3"
                >
                  <span className="text-2xl">üîä</span>
                  <span>Spila hlj√≥√∞</span>
                </button>
              </div>

              {/* Answer input */}
              <div className="mb-6">
                <label className="block text-gray-700 mb-3 font-light">
                  Skrifa√∞u setninguna sem √æ√∫ heyr√∞ir:
                </label>
                <textarea
                  value={userAnswer}
                  onChange={(e) => setUserAnswer(e.target.value)}
                  rows="3"
                  className="w-full px-4 py-3 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-gray-400 font-light text-lg"
                  placeholder="Skrifa√∞u h√©r..."
                  disabled={loading}
                />
              </div>

              {/* Feedback */}
              {feedback && (
                <div className={`mb-6 p-4 rounded-md ${feedback.correct ? 'bg-green-50 border-2 border-green-200' : 'bg-yellow-50 border-2 border-yellow-200'}`}>
                  <div className="flex items-start gap-3">
                    <span className="text-2xl">{feedback.correct ? '‚úÖ' : '‚ùå'}</span>
                    <div className="flex-1">
                      <p className={`font-medium mb-1 ${feedback.correct ? 'text-green-800' : 'text-yellow-800'}`}>
                        {feedback.correct ? 'R√©tt!' : 'Ekki alveg r√©tt'}
                      </p>
                      <p className={`text-sm font-light ${feedback.correct ? 'text-green-700' : 'text-yellow-700'}`}>
                        {feedback.message}
                      </p>
                    </div>
                  </div>
                </div>
              )}

              {/* Action buttons */}
              <div className="flex gap-4">
                <button
                  onClick={handleSubmit}
                  disabled={loading || !userAnswer.trim()}
                  className="bg-gray-800 text-white px-8 py-3 rounded-md hover:bg-gray-700 transition-colors font-light disabled:opacity-50 disabled:cursor-not-allowed"
                >
                  {loading ? 'Athuga...' : 'Athuga svar'}
                </button>
                {feedback && (
                  <button
                    onClick={handleReset}
                    className="bg-white text-gray-800 px-8 py-3 rounded-md border border-gray-300 hover:bg-gray-50 transition-colors font-light"
                  >
                    Reyna aftur
                  </button>
                )}
              </div>
            </section>
          </main>
        </div>
      );
    };

    ReactDOM.createRoot(document.getElementById('root')).render(<App />);
  </script>
</body>
</html>
