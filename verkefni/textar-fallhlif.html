<!DOCTYPE html>
<html lang="is">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>üìñ Fallhl√≠fin opna√∞ist ekki ‚Äì M√°lst√∂√∞in</title>
  <script crossorigin src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
  <script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
  <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
  <script src="https://cdn.tailwindcss.com"></script>
  <style>
    body {
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', system-ui, sans-serif;
      background: linear-gradient(to bottom, #f8f7f4 0%, #e8e6e1 100%);
      min-height: 100vh;
    }
  </style>
</head>
<body>
  <div id="root"></div>

  <script type="text/babel">
    const { useState } = React;

    const STORY_TEXT = `Victoria Cilliers er bresk kona sem stundar fallhl√≠fast√∂kk. H√∫n var vanur st√∂kkvari og haf√∞i gert √æetta oft √°√∞ur. Einn dag √≠ apr√≠l 2015 f√≥r h√∫n √≠ fallhl√≠fast√∂kk. H√∫n st√∂kk √∫r flugv√©l √≠ um 1.200 metra h√¶√∞. En eitthva√∞ var a√∞. Fallhl√≠fin opna√∞ist ekki. H√∫n reyndi a√∞ nota varafallhl√≠fina ‚Äì en h√∫n opna√∞ist heldur ekki. Victoria f√©ll hratt til jar√∞ar og slasa√∞ist miki√∞. H√∫n braut mja√∞mir, rifbein og f√¶tur. H√∫n slapp lifandi ‚Äì sem er √≥tr√∫legt, en √æurfti a√∞ vera lengi √° sj√∫krah√∫si.

L√∂greglan f√≥r a√∞ rannsaka m√°li√∞. Hvers vegna opnu√∞ust ekki fallhl√≠farnar? Br√°√∞um kom √≠ lj√≥s a√∞ einhver haf√∞i skemmt √æ√¶r viljandi. S√° gruna√∞i var eiginma√∞ur Victoriu. Hann h√©t Emile Cilliers. Hann var herma√∞ur og vann √≠ breska hernum. Hann skulda√∞i mikla peninga og √°tti √≠ √°starsambandi vi√∞ a√∞ra konu.

L√∂greglan fann l√≠ka √∫t a√∞ hann haf√∞i reynt a√∞ drepa Victoriu √°√∞ur ‚Äì hann reyndi a√∞ b√∫a til gasleka √≠ eldh√∫sinu √æeirra nokkrum d√∂gum fyrir slysi√∞. √Åri√∞ 2018 var Emile d√¶mdur sekur fyrir tv√¶r mor√∞tilraunir. Hann f√©kk l√≠fst√≠√∞arfangelsi og sleppur ekki fyrr en eftir 18 √°r. Victoria lif√∞i af og sag√∞i s√≠√∞ar √≠ vi√∞tali a√∞ h√∫n v√¶ri heppin a√∞ vera √° l√≠fi.`;

    const TRUE_FALSE = [
      { q: 'Victoria haf√∞i aldrei √°√∞ur fari√∞ √≠ fallhl√≠fast√∂kk.', correct: false },
      { q: 'B√°√∞ar fallhl√≠farnar hennar bilu√∞u.', correct: true },
      { q: 'Eiginma√∞ur Victoriu vann √≠ hernum.', correct: true },
      { q: 'Victoria slapp lifandi en slasa√∞ist.', correct: true },
      { q: 'Emile f√©kk 5 √°ra fangelsi.', correct: false }
    ];

    const WRITTEN = [
      'Hvernig slasa√∞ist Victoria √æegar h√∫n f√©ll?',
      'Af hverju gruna√∞i l√∂greglan eiginmanninn?',
      'Hva√∞ finnst √æ√©r um s√∂guna? Var eitthva√∞ sem kom √æ√©r √° √≥vart?'
    ];

    const VOCAB = [
      'fallhl√≠f',
      'varafallhl√≠f',
      'gasleki',
      'mor√∞tilraun',
      'l√≠fst√≠√∞arfangelsi'
    ];

    async function callOpenAI(payload) {
      const r = await fetch('/.netlify/functions/openai', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify(payload)
      });
      const data = await r.json();
      if (!r.ok || data.error) throw new Error(data.error || `HTTP ${r.status}`);
      return data.content;
    }

    const App = () => {
      const [stage, setStage] = useState('text');
      const [tfAnswers, setTfAnswers] = useState(Array(5).fill(null));
      const [tfFeedback, setTfFeedback] = useState(Array(5).fill(null));
      const [writtenAnswers, setWrittenAnswers] = useState(['', '', '']);
      const [writtenFeedback, setWrittenFeedback] = useState([null, null, null]);
      const [vocabAnswers, setVocabAnswers] = useState(['', '', '', '', '']);
      const [vocabFeedback, setVocabFeedback] = useState([null, null, null, null, null]);
      const [loading, setLoading] = useState(false);

      const totalScore = () => {
        let correct = 0;
        tfAnswers.forEach((ans, i) => ans === TRUE_FALSE[i].correct && correct++);
        writtenFeedback.forEach(fb => fb?.correct && correct++);
        vocabFeedback.forEach(fb => fb?.correct && correct++);
        return correct;
      };

      const handleTfSubmit = () => {
        const feedback = tfAnswers.map((ans, i) => {
          if (ans === null) return null;
          const isCorrect = ans === TRUE_FALSE[i].correct;
          return {
            correct: isCorrect,
            message: isCorrect ? 'R√©tt! ‚úì' : 'Rangt ‚úó'
          };
        });
        setTfFeedback(feedback);
      };

      const handleWrittenSubmit = async (index) => {
        const answer = writtenAnswers[index].trim();
        if (!answer) return;
        setLoading(true);

        try {
          const prompt = `√û√∫ ert kennari √≠ √≠slensku sem metur sv√∂r nemenda vi√∞ lesskilningsspurningum.

TEXTI:
${STORY_TEXT}

SPURNING:
${WRITTEN[index]}

SVAR NEMANDA:
"${answer}"

VERKEFNI:
1. Mettu hvort svari√∞ s√© r√©tt mi√∞a√∞ vi√∞ textann.
2. Sam√æykkja mismunandi or√∞alag ef merkingin er r√©tt.
3. Gef√∞u stutta, hvetjandi endurgj√∂f (1-2 setningar).

SVARA√êU A√êEINS ME√ê JSON:
{"correct": true, "feedback": "√æ√≠n endurgj√∂f h√©r"}

EKKERT ANNA√ê EN JSON.`;

          const result = await callOpenAI({
            model: 'gpt-4',
            temperature: 0.3,
            max_tokens: 150,
            messages: [{ role: 'user', content: prompt }]
          });

          // Clean result - strip markdown code blocks if present
          let cleanResult = result.trim();
          if (cleanResult.startsWith('```')) {
            cleanResult = cleanResult.replace(/```json\n?/g, '').replace(/```\n?/g, '').trim();
          }

          const parsed = JSON.parse(cleanResult);
          const newFb = [...writtenFeedback];
          newFb[index] = parsed;
          setWrittenFeedback(newFb);
        } catch (e) {
          console.error('Error:', e);
          const newFb = [...writtenFeedback];
          newFb[index] = { correct: false, feedback: 'Villa kom upp. Reyndu aftur.' };
          setWrittenFeedback(newFb);
        } finally {
          setLoading(false);
        }
      };

      const handleVocabSubmit = async (index) => {
        const answer = vocabAnswers[index].trim();
        if (!answer) return;
        setLoading(true);

        try {
          const prompt = `√û√∫ ert kennari √≠ √≠slensku sem metur skilgreiningar nemenda √° or√∞um.

OR√ê:
"${VOCAB[index]}"

SAMHENGI (textinn sem or√∞i√∞ kom √∫r):
${STORY_TEXT}

SKILGREINING NEMANDA:
"${answer}"

VERKEFNI:
1. Mettu hvort skilgreiningin s√© r√©tt e√∞a n√°l√¶gt r√©tt.
2. Sam√æykkja skilgreiningar √° √≠slensku e√∞a √∂√∞rum tungum√°lum.
3. Sam√æykkja einfaldar √∫tsk√Ωringar.
4. Gef√∞u stutta endurgj√∂f.

SVARA√êU A√êEINS ME√ê JSON:
{"correct": true, "feedback": "√æ√≠n endurgj√∂f"}

EKKERT ANNA√ê EN JSON.`;

          const result = await callOpenAI({
            model: 'gpt-4',
            temperature: 0.3,
            max_tokens: 150,
            messages: [{ role: 'user', content: prompt }]
          });

          // Clean result
          let cleanResult = result.trim();
          if (cleanResult.startsWith('```')) {
            cleanResult = cleanResult.replace(/```json\n?/g, '').replace(/```\n?/g, '').trim();
          }

          const parsed = JSON.parse(cleanResult);
          const newFb = [...vocabFeedback];
          newFb[index] = parsed;
          setVocabFeedback(newFb);
        } catch (e) {
          console.error('Error:', e);
          const newFb = [...vocabFeedback];
          newFb[index] = { correct: false, feedback: 'Villa kom upp. Reyndu aftur.' };
          setVocabFeedback(newFb);
        } finally {
          setLoading(false);
        }
      };

      const StoryPanel = () => (
        <div className="bg-white rounded-lg shadow-sm p-6 sticky top-4 max-h-[calc(100vh-2rem)] overflow-y-auto">
          <h3 className="text-lg font-medium text-gray-800 mb-4">Textinn</h3>
          <div className="prose prose-sm max-w-none">
            {STORY_TEXT.split('\n\n').map((p, i) => (
              <p key={i} className="mb-3 text-gray-700 leading-relaxed text-sm">{p}</p>
            ))}
          </div>
        </div>
      );

      return (
        <div className="min-h-screen pb-12">
          <header className="bg-white shadow-sm border-b border-gray-200">
            <div className="max-w-7xl mx-auto px-6 py-8">
              <a href="verkefni.html" className="text-sm text-gray-500 hover:text-gray-700 mb-2 inline-block">‚Üê Til baka</a>
              <h1 className="text-3xl font-light text-gray-800 mb-2">Fallhl√≠fin opna√∞ist ekki</h1>
              <p className="text-gray-500 text-sm font-light">Lesskilningur ¬∑ A2-B1</p>
            </div>
          </header>

          {stage === 'text' && (
            <main className="max-w-4xl mx-auto px-6 mt-8">
              <section className="bg-white rounded-lg shadow-sm p-8 mb-6">
                <div className="prose prose-lg max-w-none">
                  {STORY_TEXT.split('\n\n').map((p, i) => (
                    <p key={i} className="mb-4 text-gray-700 leading-relaxed font-light">{p}</p>
                  ))}
                </div>
                <div className="mt-8 pt-6 border-t border-gray-200">
                  <button
                    onClick={() => setStage('tfQuiz')}
                    className="bg-gray-800 text-white px-8 py-3 rounded-md hover:bg-gray-700 transition-colors font-light"
                  >
                    Byrja √¶fingar ‚Üí
                  </button>
                </div>
              </section>
            </main>
          )}

          {(stage === 'tfQuiz' || stage === 'written' || stage === 'vocab') && (
            <main className="max-w-7xl mx-auto px-6 mt-8">
              <div className="grid lg:grid-cols-3 gap-6">
                {/* Left: Story (hidden on mobile) */}
                <div className="hidden lg:block">
                  <StoryPanel />
                </div>

                {/* Right: Quiz */}
                <div className="lg:col-span-2">
                  {/* Mobile: Collapsible story */}
                  <details className="lg:hidden mb-6 bg-white rounded-lg shadow-sm">
                    <summary className="p-4 cursor-pointer font-medium text-gray-700">
                      üìñ Sj√° textann
                    </summary>
                    <div className="p-4 pt-0 border-t">
                      <div className="prose prose-sm max-w-none">
                        {STORY_TEXT.split('\n\n').map((p, i) => (
                          <p key={i} className="mb-3 text-gray-700 leading-relaxed text-sm">{p}</p>
                        ))}
                      </div>
                    </div>
                  </details>

                  {stage === 'tfQuiz' && (
                    <section className="bg-white rounded-lg shadow-sm p-8">
                      <h2 className="text-2xl font-light text-gray-800 mb-6">A. R√©tt e√∞a rangt?</h2>
                      <div className="space-y-6">
                        {TRUE_FALSE.map((item, i) => (
                          <div key={i} className="pb-6 border-b border-gray-100 last:border-0">
                            <p className="text-gray-700 mb-3 font-light">{i + 1}. {item.q}</p>
                            <div className="flex gap-4 items-center flex-wrap">
                              <label className="flex items-center gap-2 cursor-pointer">
                                <input
                                  type="radio"
                                  name={`tf-${i}`}
                                  checked={tfAnswers[i] === true}
                                  onChange={() => {
                                    const newA = [...tfAnswers];
                                    newA[i] = true;
                                    setTfAnswers(newA);
                                  }}
                                  className="w-4 h-4"
                                />
                                <span className="text-gray-600 font-light">R√©tt</span>
                              </label>
                              <label className="flex items-center gap-2 cursor-pointer">
                                <input
                                  type="radio"
                                  name={`tf-${i}`}
                                  checked={tfAnswers[i] === false}
                                  onChange={() => {
                                    const newA = [...tfAnswers];
                                    newA[i] = false;
                                    setTfAnswers(newA);
                                  }}
                                  className="w-4 h-4"
                                />
                                <span className="text-gray-600 font-light">Rangt</span>
                              </label>
                              {tfFeedback[i] && (
                                <span className={`ml-4 text-sm ${tfFeedback[i].correct ? 'text-green-600' : 'text-red-600'}`}>
                                  {tfFeedback[i].message}
                                </span>
                              )}
                            </div>
                          </div>
                        ))}
                      </div>
                      <div className="mt-8 flex gap-4">
                        <button
                          onClick={handleTfSubmit}
                          className="bg-gray-800 text-white px-6 py-2 rounded-md hover:bg-gray-700 transition-colors font-light"
                        >
                          Athuga sv√∂r
                        </button>
                        <button
                          onClick={() => setStage('written')}
                          className="bg-white text-gray-800 px-6 py-2 rounded-md border border-gray-300 hover:bg-gray-50 transition-colors font-light"
                        >
                          √Åfram ‚Üí
                        </button>
                      </div>
                    </section>
                  )}

                  {stage === 'written' && (
                    <section className="bg-white rounded-lg shadow-sm p-8">
                      <h2 className="text-2xl font-light text-gray-800 mb-6">B. Skrifa√∞u</h2>
                      <div className="space-y-8">
                        {WRITTEN.map((q, i) => (
                          <div key={i}>
                            <label className="block text-gray-700 mb-2 font-light">{i + 1}. {q}</label>
                            <textarea
                              value={writtenAnswers[i]}
                              onChange={(e) => {
                                const newA = [...writtenAnswers];
                                newA[i] = e.target.value;
                                setWrittenAnswers(newA);
                              }}
                              rows="3"
                              className="w-full px-4 py-3 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-gray-400 font-light"
                              placeholder="Skrifa√∞u svari√∞ √æitt h√©r..."
                            />
                            {writtenFeedback[i] && (
                              <div className={`mt-2 p-3 rounded-md ${writtenFeedback[i].correct ? 'bg-green-50 text-green-700' : 'bg-yellow-50 text-yellow-700'}`}>
                                <p className="text-sm font-light">{writtenFeedback[i].feedback}</p>
                              </div>
                            )}
                            <button
                              onClick={() => handleWrittenSubmit(i)}
                              disabled={loading || !writtenAnswers[i].trim()}
                              className="mt-2 text-sm text-gray-600 hover:text-gray-800 underline disabled:opacity-50 disabled:cursor-not-allowed font-light"
                            >
                              {loading ? 'Athuga...' : 'Athuga svar'}
                            </button>
                          </div>
                        ))}
                      </div>
                      <div className="mt-8 flex gap-4">
                        <button
                          onClick={() => setStage('tfQuiz')}
                          className="bg-white text-gray-800 px-6 py-2 rounded-md border border-gray-300 hover:bg-gray-50 transition-colors font-light"
                        >
                          ‚Üê Til baka
                        </button>
                        <button
                          onClick={() => setStage('vocab')}
                          className="bg-gray-800 text-white px-6 py-2 rounded-md hover:bg-gray-700 transition-colors font-light"
                        >
                          √Åfram ‚Üí
                        </button>
                      </div>
                    </section>
                  )}

                  {stage === 'vocab' && (
                    <section className="bg-white rounded-lg shadow-sm p-8">
                      <h2 className="text-2xl font-light text-gray-800 mb-6">C. N√Ω or√∞</h2>
                      <p className="text-gray-600 mb-6 font-light">Hva√∞ √æ√Ω√∞a √æessi or√∞? Skrifa√∞u sk√Ωringu √° √≠slensku e√∞a √æ√≠nu tungum√°li.</p>
                      <div className="space-y-6">
                        {VOCAB.map((word, i) => (
                          <div key={i}>
                            <label className="block text-gray-700 mb-2 font-light">‚Ä¢ {word}</label>
                            <input
                              type="text"
                              value={vocabAnswers[i]}
                              onChange={(e) => {
                                const newA = [...vocabAnswers];
                                newA[i] = e.target.value;
                                setVocabAnswers(newA);
                              }}
                              className="w-full px-4 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-gray-400 font-light"
                              placeholder="Skrifa√∞u skilgreiningu..."
                            />
                            {vocabFeedback[i] && (
                              <div className={`mt-2 p-3 rounded-md ${vocabFeedback[i].correct ? 'bg-green-50 text-green-700' : 'bg-yellow-50 text-yellow-700'}`}>
                                <p className="text-sm font-light">{vocabFeedback[i].feedback}</p>
                              </div>
                            )}
                            <button
                              onClick={() => handleVocabSubmit(i)}
                              disabled={loading || !vocabAnswers[i].trim()}
                              className="mt-2 text-sm text-gray-600 hover:text-gray-800 underline disabled:opacity-50 disabled:cursor-not-allowed font-light"
                            >
                              {loading ? 'Athuga...' : 'Athuga svar'}
                            </button>
                          </div>
                        ))}
                      </div>
                      <div className="mt-8 flex gap-4">
                        <button
                          onClick={() => setStage('written')}
                          className="bg-white text-gray-800 px-6 py-2 rounded-md border border-gray-300 hover:bg-gray-50 transition-colors font-light"
                        >
                          ‚Üê Til baka
                        </button>
                        <button
                          onClick={() => setStage('results')}
                          className="bg-gray-800 text-white px-6 py-2 rounded-md hover:bg-gray-700 transition-colors font-light"
                        >
                          Sj√° ni√∞urst√∂√∞ur
                        </button>
                      </div>
                    </section>
                  )}
                </div>
              </div>
            </main>
          )}

          {stage === 'results' && (
            <main className="max-w-4xl mx-auto px-6 mt-8">
              <section className="bg-white rounded-lg shadow-sm p-8 text-center">
                <div className="text-6xl mb-4">üéâ</div>
                <h2 className="text-3xl font-light text-gray-800 mb-4">Vel gert!</h2>
                <div className="bg-gray-50 rounded-lg p-6 mb-6 inline-block">
                  <p className="text-gray-600 mb-2 font-light">√û√≠n einkunn:</p>
                  <p className="text-5xl font-light text-gray-800">{totalScore()}/13</p>
                </div>
                <p className="text-gray-600 mb-8 font-light">√û√∫ hefur kl√°ra√∞ √¶finguna!</p>
                <div className="flex gap-4 justify-center flex-wrap">
                  <button
                    onClick={() => {
                      setStage('text');
                      setTfAnswers(Array(5).fill(null));
                      setTfFeedback(Array(5).fill(null));
                      setWrittenAnswers(['', '', '']);
                      setWrittenFeedback([null, null, null]);
                      setVocabAnswers(['', '', '', '', '']);
                      setVocabFeedback([null, null, null, null, null]);
                    }}
                    className="bg-gray-800 text-white px-6 py-3 rounded-md hover:bg-gray-700 transition-colors font-light"
                  >
                    Byrja aftur
                  </button>
                  <a
                    href="verkefni.html"
                    className="bg-white text-gray-800 px-6 py-3 rounded-md border border-gray-300 hover:bg-gray-50 transition-colors font-light inline-block"
                  >
                    Til baka √° Verkefni
                  </a>
                </div>
              </section>
            </main>
          )}
        </div>
      );
    };

    ReactDOM.createRoot(document.getElementById('root')).render(<App />);
  </script>
</body>
</html>
