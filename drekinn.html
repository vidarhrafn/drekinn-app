<!DOCTYPE html>
<html lang="is">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>💬 Málmenni – Málstöðin</title>
  <script crossorigin src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
  <script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
  <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
  <script src="https://cdn.tailwindcss.com"></script>
  <style>
    body {
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', system-ui, sans-serif;
      background: linear-gradient(to bottom, #f8f7f4 0%, #e8e6e1 100%);
      min-height: 100vh;
    }
  </style>
</head>
<body>
  <div id="root"></div>

  <script type="text/babel">
    const { useState, useEffect, useRef } = React;

    // ---------------- Icons ----------------
    const SendIcon = () => (
      <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2">
        <line x1="22" y1="2" x2="11" y2="13"></line>
        <polygon points="22 2 15 22 11 13 2 9 22 2"></polygon>
      </svg>
    );
    const CreditCardIcon = () => (
      <svg width="64" height="64" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2">
        <rect x="1" y="4" width="22" height="16" rx="2" ry="2"></rect>
        <line x1="1" y1="10" x2="23" y2="10"></line>
      </svg>
    );

    // -------------- Helpers ---------------
    function menuToText(menu) {
      const cat = (title, items) =>
        `${title}:\n` + items.map(i => `- ${i.name}: ${i.price} kr`).join('\n');

      return [
        "MATSEÐILL DREKANS:",
        cat("Hamborgarar", menu.hamborgarar),
        cat("Meðlæti", menu.medlaeti),
        cat("Drykkir", menu.drykkir),
        cat("Tilboð", menu.tilbod),
      ].join("\n\n");
    }

    function parseActionFromAssistant(text) {
      const lines = text.trim().split('\n');
      const last = lines[lines.length - 1].trim();
      try {
        const obj = JSON.parse(last);
        return obj?.action || "none";
      } catch {
        return "none";
      }
    }

    // -------------- App ----------------
    const Drekinn = () => {
      const [messages, setMessages] = useState([]);
      const [input, setInput] = useState('');
      const [loading, setLoading] = useState(false);
      const [stage, setStage] = useState('ordering');
      const [orderNumber, setOrderNumber] = useState(null);
      const [paymentStep, setPaymentStep] = useState('idle');
      const messagesEndRef = useRef(null);

      const menu = {
        hamborgarar: [
          { name: 'Drekaborgarinn',     price: 1590 },
          { name: 'Ostaborgarinn',      price: 1690 },
          { name: 'Bacon Deluxe',       price: 1890 },
          { name: 'Kjúklingaborgarinn', price: 1790 },
        ],
        medlaeti: [
          { name: 'Franskar litlar', price: 490 },
          { name: 'Franskar stórar', price: 690 },
          { name: 'Laukhringir',     price: 590 },
          { name: 'Kjúklinganaggar', price: 890 },
        ],
        drykkir: [
          { name: 'Gos stórt',         price: 390 },
          { name: 'Gos lítið',         price: 290 },
          { name: 'Mjólkurhristingur', price: 690 },
          { name: 'Kaffi',             price: 390 },
        ],
        tilbod: [
          { name: 'Hamborgaratilboð', price: 2290 },
          { name: 'Stóra tilboðið',   price: 3990 },
        ],
      };

      useEffect(() => {
        setMessages([{ role: 'assistant', content: 'Hæ og velkomin á Drekann! Hvað má bjóða þér í dag? 😊' }]);
      }, []);

      useEffect(() => {
        messagesEndRef.current?.scrollIntoView({ behavior: 'smooth' });
      }, [messages, loading]);

      async function callOpenAI(payload) {
        const r = await fetch('/.netlify/functions/openai', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify(payload),
        });
        const data = await r.json();
        if (!r.ok || data.error) throw new Error(data.error || `HTTP ${r.status}`);
        return data.content;
      }

      const sendMessage = async () => {
        const trimmed = input.trim();
        if (!trimmed || loading) return;

        const userMessage = { role: 'user', content: trimmed };
        setMessages(prev => [...prev, userMessage]);
        setInput('');
        setLoading(true);

        // Málfarsendurgjöf
        try {
          const feedbackMessages = [
            {
              role: 'system',
              content: `
Þú ert íslenskukennari sem gefur örstutta, hlýja og hvetjandi endurgjöf á íslensku (A2–B1).
REGLUR:
- 1–2 stuttar setningar, aldrei lengra.
- Leiðréttu aðeins þegar þú ert >80% viss.
- Forðastu of formlegt/bóklegt mál.
- Ekki nota ensku. Ekki útskýra nema nauðsynlegt sé fyrir skilning.
`.trim()
            },
            {
              role: 'user',
              content: `Skilaboð nemanda: "${trimmed}". Gefðu aðeins endurgjöfarlínuna, ekkert annað.`
            }
          ];

          const feedback = await callOpenAI({
            model: 'gpt-4o-mini',
            temperature: 0.2,
            max_tokens: 60,
            messages: feedbackMessages,
          });

          if (feedback && typeof feedback === 'string') {
            setMessages(prev => [...prev, { role: 'feedback', content: feedback }]);
            await new Promise(res => setTimeout(res, 500));
          }
        } catch (e) {
          console.error('Feedback error:', e);
        }

        // Aðal-svar
        try {
          const sys = `
Þú ert vingjarnlegur starfsmaður á Drekanum, vinsælum íslenskum skyndibitastað.

${menuToText(menu)}

VERKEFNI:
1. Hjálpa viðskiptavinum að velja af matseðlinum (bara ef beðið er um það)
2. Reikna heildarverð (bara ef beðið er um það)
3. Staðfesta pöntun þegar viðskiptavinur er tilbúinn
4. Skila JSON-aðgerð í síðustu línu svars: {"action":"none"} eða {"action":"confirm_order"}

STÍLL:
- Stuttar, eðlilegar og kurteisar setningar á nútímalegri íslensku.
- Ekki leiðrétta málfar. Ekki kennslumál. Engin bullet points nema beðið sé um það.
- Emoji má nota sparlega.

MÁLFRÆÐIREGLUR:
- Gættu að fallbeygingu og samræmi (kyn, tala, fall).

ÚTTAK:
- Fyrst svartexti (náttúrulegt samtal).
- **Síðasta lína**: JSON með aðgerðinni á einni línu.
`.trim();

          const conversationHistory = messages
            .filter(m => m.role === 'assistant' || m.role === 'user')
            .map(m => ({ role: m.role, content: m.content }));

          const assistantReply = await callOpenAI({
            model: 'gpt-4o-mini',
            temperature: 0.3,
            max_tokens: 220,
            messages: [
              { role: 'system', content: sys },
              ...conversationHistory,
              userMessage,
            ],
          });

          if (assistantReply) {
            setMessages(prev => [...prev, { role: 'assistant', content: assistantReply }]);
            const action = parseActionFromAssistant(assistantReply);
            if (action === 'confirm_order') {
              setTimeout(() => setStage('payment'), 600);
            }
          }
        } catch (e) {
          console.error('Assistant error:', e);
          setMessages(prev => [
            ...prev,
            { role: 'assistant', content: 'Úps, eitthvað fór úrskeiðis. Prófum aftur á eftir.' }
          ]);
        } finally {
          setLoading(false);
        }
      };

      const handlePayment = () => {
        setPaymentStep('inserting');
        setTimeout(() => {
          setPaymentStep('processing');
          setTimeout(() => {
            setPaymentStep('success');
            const randomOrderNum = Math.floor(Math.random() * 900) + 100;
            setOrderNumber(randomOrderNum);
            setTimeout(() => setStage('complete'), 1500);
          }, 1800);
        }, 1200);
      };

      return (
        <div className="min-h-screen pb-12">
          {/* Header með Málstöðin útliti */}
          <header className="bg-white shadow-sm border-b border-gray-200">
            <div className="max-w-7xl mx-auto px-6 py-8">
              <button 
                onClick={() => window.history.back()} 
                className="text-sm text-gray-500 hover:text-gray-700 mb-2 inline-block font-light"
              >
                ← Til baka
              </button>
              <h1 className="text-3xl font-light text-gray-800 mb-2">Drekinn – Skyndibitastaður</h1>
              <p className="text-gray-500 text-sm font-light">Samtalsæfing · A2-B1</p>
            </div>
          </header>

          <main className="max-w-7xl mx-auto px-6 mt-8">
            <div className="grid md:grid-cols-3 gap-6">
              {/* Matseðill */}
              <aside className="md:col-span-1 bg-white rounded-lg shadow-sm p-6">
                <h2 className="text-xl font-light text-gray-800 mb-4">Matseðill</h2>

                <section className="space-y-6">
                  <div>
                    <h3 className="font-normal text-base text-gray-700 mb-2">🍔 Hamborgarar</h3>
                    {menu.hamborgarar.map((item, idx) => (
                      <div key={idx} className="flex justify-between py-1 text-sm font-light">
                        <span>{item.name}</span>
                        <span className="font-normal">{item.price} kr</span>
                      </div>
                    ))}
                  </div>

                  <div>
                    <h3 className="font-normal text-base text-gray-700 mb-2">🍟 Meðlæti</h3>
                    {menu.medlaeti.map((item, idx) => (
                      <div key={idx} className="flex justify-between py-1 text-sm font-light">
                        <span>{item.name}</span>
                        <span className="font-normal">{item.price} kr</span>
                      </div>
                    ))}
                  </div>

                  <div>
                    <h3 className="font-normal text-base text-gray-700 mb-2">🥤 Drykkir</h3>
                    {menu.drykkir.map((item, idx) => (
                      <div key={idx} className="flex justify-between py-1 text-sm font-light">
                        <span>{item.name}</span>
                        <span className="font-normal">{item.price} kr</span>
                      </div>
                    ))}
                  </div>

                  <div>
                    <h3 className="font-normal text-base text-gray-700 mb-2">⭐ Tilboð</h3>
                    {menu.tilbod.map((item, idx) => (
                      <div key={idx} className="flex justify-between py-1 text-sm font-light">
                        <span>{item.name}</span>
                        <span className="font-normal text-gray-700">{item.price} kr</span>
                      </div>
                    ))}
                  </div>
                </section>
              </aside>

              {/* Spjall + greiðsla */}
              <section className="md:col-span-2 bg-white rounded-lg shadow-sm overflow-hidden flex flex-col h-[600px]">
                {stage === 'ordering' && (
                  <>
                    <div className="flex-1 overflow-y-auto p-6 space-y-4">
                      {messages.map((msg, idx) => (
                        <div
                          key={idx}
                          className={`flex ${
                            msg.role === 'user'
                              ? 'justify-end'
                              : msg.role === 'feedback'
                              ? 'justify-center'
                              : 'justify-start'
                          }`}
                        >
                          <div
                            className={`max-w-lg px-4 py-2 rounded-lg font-light ${
                              msg.role === 'user'
                                ? 'bg-gray-800 text-white'
                                : msg.role === 'feedback'
                                ? 'bg-blue-50 text-blue-800 border border-blue-200 text-sm italic'
                                : 'bg-gray-100 text-gray-800'
                            }`}
                          >
                            {msg.role === 'feedback' && <span className="font-normal">📚 Málfar: </span>}
                            {msg.content}
                          </div>
                        </div>
                      ))}

                      {loading && (
                        <div className="flex justify-start">
                          <div className="bg-gray-100 text-gray-800 px-4 py-2 rounded-lg">
                            <div className="flex space-x-2">
                              <div className="w-2 h-2 bg-gray-400 rounded-full animate-bounce"></div>
                              <div className="w-2 h-2 bg-gray-400 rounded-full animate-bounce" style={{animationDelay: '0.1s'}}></div>
                              <div className="w-2 h-2 bg-gray-400 rounded-full animate-bounce" style={{animationDelay: '0.2s'}}></div>
                            </div>
                          </div>
                        </div>
                      )}
                      <div ref={messagesEndRef} />
                    </div>

                    <div className="border-t p-4">
                      <div className="flex gap-2">
                        <input
                          type="text"
                          value={input}
                          onChange={(e) => setInput(e.target.value)}
                          onKeyDown={(e) => e.key === 'Enter' && sendMessage()}
                          placeholder="Skrifaðu pöntunina þína..."
                          className="flex-1 px-4 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-gray-400 font-light"
                          disabled={loading}
                        />
                        <button
                          onClick={sendMessage}
                          disabled={loading || !input.trim()}
                          className="bg-gray-800 text-white px-6 py-2 rounded-md hover:bg-gray-700 disabled:bg-gray-300 disabled:cursor-not-allowed transition-colors font-light"
                          aria-label="Senda skilaboð"
                          title="Senda"
                        >
                          <SendIcon />
                        </button>
                      </div>
                    </div>
                  </>
                )}

                {stage === 'payment' && (
                  <div className="flex-1 flex items-center justify-center p-6">
                    <div className="text-center">
                      <h2 className="text-3xl font-light text-gray-800 mb-8">Greiðsla</h2>

                      <div className="bg-gray-800 rounded-lg p-8 mb-6 relative overflow-hidden">
                        <div className="w-64 h-40 bg-gradient-to-br from-gray-700 to-gray-900 rounded-lg flex items-center justify-center">
                          {paymentStep === 'idle' && (
                            <div className="text-gray-400">
                              <CreditCardIcon />
                            </div>
                          )}
                          {paymentStep === 'inserting' && (
                            <div className="text-yellow-400 animate-pulse">
                              <CreditCardIcon />
                              <p className="mt-2 text-sm font-light">Setjið kortið á posa...</p>
                            </div>
                          )}
                          {paymentStep === 'processing' && (
                            <div className="text-blue-400">
                              <div className="animate-spin rounded-full h-16 w-16 border-b-2 border-blue-400 mx-auto"></div>
                              <p className="mt-4 text-sm font-light">Vinnsla...</p>
                            </div>
                          )}
                          {paymentStep === 'success' && (
                            <div className="text-green-400">
                              <div className="text-6xl mb-2">✓</div>
                              <p className="text-lg font-normal">BIP! 🎉</p>
                              <p className="text-sm font-light">Greitt!</p>
                            </div>
                          )}
                        </div>
                      </div>

                      {paymentStep === 'idle' && (
                        <button
                          onClick={handlePayment}
                          className="bg-gray-800 text-white px-8 py-4 rounded-md text-xl font-light hover:bg-gray-700 transition-colors shadow-sm"
                        >
                          Setja kort á posa
                        </button>
                      )}
                    </div>
                  </div>
                )}

                {stage === 'complete' && (
                  <div className="flex-1 flex items-center justify-center p-6">
                    <div className="text-center">
                      <div className="text-6xl mb-4">🎉</div>
                      <h2 className="text-3xl font-light text-gray-800 mb-4">Takk fyrir!</h2>
                      <div className="bg-gray-50 rounded-lg p-6 mb-6 border border-gray-200">
                        <p className="text-gray-600 mb-2 font-light">Pöntunarnúmer:</p>
                        <p className="text-5xl font-light text-gray-800">#{orderNumber}</p>
                      </div>
                      <p className="text-xl text-gray-600 mb-8 font-light">
                        Við látum þig vita þegar pöntunin er tilbúin!
                      </p>
                      <button
                        onClick={() => {
                          setStage('ordering');
                          setMessages([{ role: 'assistant', content: 'Hæ og velkomin aftur á Drekann! Hvað má bjóða þér í dag? 😊' }]);
                          setPaymentStep('idle');
                          setOrderNumber(null);
                        }}
                        className="bg-gray-800 text-white px-6 py-3 rounded-md hover:bg-gray-700 transition-colors font-light"
                      >
                        Ný pöntun
                      </button>
                    </div>
                  </div>
                )}
              </section>
            </div>
          </main>
        </div>
      );
    };

    ReactDOM.createRoot(document.getElementById('root')).render(<Drekinn />);
  </script>
</body>
</html>
